(function(f,a){typeof exports=="object"&&typeof module<"u"?a(exports,require("three")):typeof define=="function"&&define.amd?define(["exports","three"],a):(f=typeof globalThis<"u"?globalThis:f||self,a(f.tt={},f.THREE))})(this,function(f,a){"use strict";const se={name:"three-tile",private:!1,version:"0.5.0",type:"module",files:["dist"],main:"dist/three-tile.umd.cjs",module:"dist/three-tile.js",types:"./dist/three-tile.es.d.ts",exports:{".":{import:"./dist/three-tile.js",require:"./dist/three-tile.umd.cjs",types:"./dist/three-tile.es.d.ts"}},description:"A lightweight tile map using threejs",license:"GPL V3",author:{name:"GuoJiangfeng",email:"hz_gjf@163.com"},keywords:["three","gis","tile","map","3D","cesium"],scripts:{dev:"vite --config vite.config.dev.ts",lib:"tsc && vite build  --config vite.config.lib.ts",demo:"tsc && vite build  --config vite.config.demo.ts",docs:"typedoc src --out ./docs",lint:"eslint --ext .tsx,.ts ./src ",fix:"eslint --ext .tsx,.ts ./src --fix"},devDependencies:{"@types/node":"^20.2.3","@types/offscreencanvas":"^2019.7.0","@types/three":"^0.152.1","@typescript-eslint/eslint-plugin":"^7.5.0","@typescript-eslint/parser":"^7.5.0",eslint:"^8.57.0",typedoc:"^0.23.23",typescript:"^5.0.4",vite:"^4.0.0","vite-plugin-dts":"^2.3.0","vite-plugin-wasm":"^3.3.0"},dependencies:{esbuild:"^0.18.20",three:"^0.152.2"}};function V(s,e,r,t,i){const o=new G(s,e,r);return o.position.copy(t),o.scale.copy(i),o}function ke(s,e=!1){if(s.isLeaf){const r=s.coord.z+1,t=s.coord.x*2,i=0,o=1/4;if(s.coord.z===0&&e){const c=s.coord.y,l=new a.Vector3(.5,1,1);s.add(V(t,c,r,new a.Vector3(-o,0,i),l)),s.add(V(t+1,c,r,new a.Vector3(o,0,i),l))}else{const c=s.coord.y*2,l=new a.Vector3(.5,.5,1);s.add(V(t,c+1,r,new a.Vector3(-o,-o,i),l)),s.add(V(t+1,c+1,r,new a.Vector3(o,-o,i),l)),s.add(V(t,c,r,new a.Vector3(-o,o,i),l)),s.add(V(t+1,c,r,new a.Vector3(o,o,i),l))}s.traverse(c=>{c.updateMatrix(),c.updateMatrixWorld(),c.receiveShadow=s.receiveShadow,c.castShadow=s.castShadow})}return s.children}const Re=new a.Vector3;function Ue(s,e,r){const t=s.position.clone().setZ(r).applyMatrix4(s.matrixWorld);return e.distanceTo(t)}function Ve(s){const e=new a.Vector3(-.5,-.5,0).applyMatrix4(s.matrixWorld),r=new a.Vector3(.5,.5,0).applyMatrix4(s.matrixWorld);return e.sub(r).length()}function ce(s,e){const r=e.getWorldPosition(Re),t=Ue(s,r,s.avgZ),i=Ve(s),o=t/i;return Math.log10(o)*5+.5}var Y=(s=>(s[s.none=0]="none",s[s.create=1]="create",s[s.remove=2]="remove",s))(Y||{});function Fe(s,e,r,t,i){if(s.coord.z>r&&s.index===0&&s.parent?.isTile){const c=ce(s.parent,e);if(s.coord.z>t||c>i*1.02)return 2}if(s.coord.z<t&&s.isLeafInFrustum){const c=ce(s,e);if(s.userData.dist=c,s.coord.z<r||c<i/1.02)return 1}return 0}const W=new a.PlaneGeometry,$=new a.MeshBasicMaterial({color:16711680});class G extends a.Mesh{coord;isTile=!0;parent=null;children=[];maxZ=0;minZ=0;avgZ=0;get index(){return this.parent?this.parent.children.indexOf(this):-1}_abortController=new AbortController;get abortSignal(){return this._abortController.signal}_loadState="empty";get loadState(){return this._loadState}_toLoad=!1;get _needsLoad(){return this.inFrustum&&this._toLoad&&this.loadState==="empty"}_inFrustum=!1;get inFrustum(){return this._inFrustum}set inFrustum(e){this._inFrustum!=e&&(this._inFrustum=e,e?this._toLoad=this.isLeaf:this.dispose(!0))}get isLeafInFrustum(){return this.inFrustum&&this.isLeaf}set isTemp(e){this.material.forEach(r=>{"wireframe"in r&&(r.wireframe=e||r.userData.wireframe)})}get isLeaf(){return this.children.length===0}constructor(e=0,r=0,t=0){super(W,[$]),this.coord={x:e,y:r,z:t},this.name=`Tile ${t}-${e}-${r}`,this.matrixAutoUpdate=!1,this.matrixWorldAutoUpdate=!1}traverse(e){e(this),this.children.forEach(r=>{r.traverse(e)})}raycast(e,r){this.loadState==="loaded"&&super.raycast(e,r)}_lod(e,r,t,i,o){let c=[];const l=Fe(this,e,r,t,i);if(l===Y.create)c=ke(this,o),this._toLoad=!1;else if(l===Y.remove){const d=this.parent;d?.isTile&&(d._toLoad=!0)}return c}_load(e){return this._needsLoad?(this._abortController=new AbortController,this._loadState="loading",new Promise((r,t)=>{e.load(this,()=>r(this._onLoad()),i=>r(this._onError(i)))})):Promise.resolve(!1)}_onError(e){return this._toLoad=!1,e.name==="AbortError"?(console.assert(this._loadState==="empty"),console.log(e.message)):(this._loadState="loaded",console.error(e.message||e.type||e)),!1}hasLoadedParent(){const e=this.parent;return!e||!e.isTile?null:e.loadState==="loaded"?e:e.hasLoadedParent()}_onLoad(){if(this.loadState==="empty")return!1;if(!this.inFrustum)debugger;return this._loadState="loaded",this._updateZ(),this.material.forEach(e=>{"wireframe"in e&&(e.userData.wireframe=e.wireframe)}),this.isLeaf?this.isTemp=this.hasLoadedParent()!=null:this._toLoad?(this.isTemp=!1,this.children.forEach(e=>e.dispose(!0)),this.clear()):this.dispose(!1),this._toLoad=!1,!0}_updateZ(){this.geometry.computeBoundingBox(),this.maxZ=this.geometry.boundingBox?.max.z||0,this.minZ=this.geometry.boundingBox?.min.z||0,this.avgZ=(this.maxZ+this.minZ)/2}abortLoad(){this._abortController.abort()}dispose(e){return this.loadState!="empty"&&this._dispose(),e&&(this.children.forEach(r=>{r.dispose(e),r.clear()}),this.clear()),this}_dispose(){this.abortLoad(),this._loadState="empty",this.isTemp=!0,this.material[0]!=$&&(this.material.forEach(e=>e.dispose()),this.material=[$]),this.geometry!=W&&(this.geometry.dispose(),this.geometry.groups=[],this.geometry=W),this.dispatchEvent({type:"dispose"})}}const Be=new a.Matrix4,le=new a.Frustum;class K extends G{_treeReadyCount=0;_autoLoad=!0;_loader;_minLevel=0;get minLevel(){return this._minLevel}set minLevel(e){this._minLevel=e}_maxLevel=19;get maxLevel(){return this._maxLevel}set maxLevel(e){this._maxLevel=e}_LODThreshold=1;get LODThreshold(){return this._LODThreshold}set LODThreshold(e){this._LODThreshold=e}isWGS=!1;get loader(){return this._loader}set loader(e){this._loader=e}get autoLoad(){return this._autoLoad}set autoLoad(e){this._autoLoad=e}_vierwerBufferSize=.6;_tileBox=new a.Box3(new a.Vector3(-this.viewerbufferSize,-this.viewerbufferSize,0),new a.Vector3(this.viewerbufferSize,this.viewerbufferSize,10));get viewerbufferSize(){return this._vierwerBufferSize}set viewerbufferSize(e){this._vierwerBufferSize=Math.min(Math.max(e,.5),2.5),this._tileBox=new a.Box3(new a.Vector3(-this.viewerbufferSize,-this.viewerbufferSize,0),new a.Vector3(this.viewerbufferSize,this.viewerbufferSize,9))}constructor(e,r=0,t=0,i=0){super(r,t,i),this._loader=e,this.matrixAutoUpdate=!0,this.matrixWorldAutoUpdate=!0}update(e){return this._updateTileTree(e)?this._treeReadyCount=0:this._treeReadyCount=Math.min(this._treeReadyCount+1,100),this.autoLoad&&this._treeReadyCount>2&&this._updateTileData(),this}reload(){return this.dispose(!0),this}_updateTileTree(e){let r=!1;return le.setFromProjectionMatrix(Be.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse)),this.traverse(t=>{if(t.isTile){t.geometry.computeBoundingBox(),t.geometry.computeBoundingSphere(),t.inFrustum=le.intersectsBox(this._tileBox.clone().applyMatrix4(t.matrixWorld));const i=t._lod(e,this.minLevel,this.maxLevel,this.LODThreshold,this.isWGS);i.forEach(o=>{this.dispatchEvent({type:"tile-created",tile:o})}),i.length>0&&(r=!0)}}),r}_updateTileData(){return this.traverse(e=>{e.isTile&&e._load(this.loader).then(r=>{r&&(this._updateVisible()&&(this.dispatchEvent({type:"loaded",tile:e}),console.log("ok")),this._updateVisibleZ()),this.dispatchEvent({type:"tile-loaded",tile:e})})}),this}_updateVisible(){const e=r=>{if(!r.inFrustum)return!0;if(r.isLeaf)return r.loadState==="loaded";const t=r.children.every(i=>e(i));return t&&r.children.forEach(i=>{i.inFrustum&&(i.isLeaf?i.isTemp=!1:i.dispose(!1))}),t};return e(this)}_updateVisibleZ(){let e=0,r=0;this.maxZ=0,this.minZ=9e3,this.traverse(t=>{t.isTile&&t.isLeafInFrustum&&t.loadState==="loaded"&&(this.maxZ=Math.max(this.maxZ,t.maxZ),this.minZ=Math.min(this.minZ,t.minZ),e+=t.avgZ,r++)}),r>0&&(this.avgZ=e/r)}}const Ge=`\r
// #define LAMBERT\r
\r
uniform vec3 diffuse;\r
uniform vec3 emissive;\r
uniform float opacity;\r
\r
uniform sampler2D map;\r
uniform sampler2D map1;\r
\r
varying vec2 vUv;\r
\r
#include <common>\r
#include <packing>\r
#include <dithering_pars_fragment>\r
#include <color_pars_fragment>\r
#include <uv_pars_fragment>\r
#include <map_pars_fragment>\r
#include <alphamap_pars_fragment>\r
#include <alphatest_pars_fragment>\r
#include <aomap_pars_fragment>\r
#include <lightmap_pars_fragment>\r
#include <emissivemap_pars_fragment>\r
#include <envmap_common_pars_fragment>\r
#include <envmap_pars_fragment>\r
#include <fog_pars_fragment>\r
#include <bsdfs>\r
#include <lights_pars_begin>\r
#include <normal_pars_fragment>\r
#include <lights_lambert_pars_fragment>\r
#include <shadowmap_pars_fragment>\r
#include <bumpmap_pars_fragment>\r
#include <normalmap_pars_fragment>\r
#include <specularmap_pars_fragment>\r
#include <logdepthbuf_pars_fragment>\r
#include <clipping_planes_pars_fragment>\r
\r
void main() {\r
\r
	#include <clipping_planes_fragment>\r
\r
	vec4 diffuseColor = vec4( diffuse, opacity );\r
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\r
	vec3 totalEmissiveRadiance = emissive;\r
\r
	#include <logdepthbuf_fragment>\r
	#include <map_fragment>\r
	#include <color_fragment>\r
	#include <alphamap_fragment>\r
	\r
	\r
	#include <alphatest_fragment>\r
	#include <specularmap_fragment>\r
	#include <normal_fragment_begin>\r
	#include <normal_fragment_maps>\r
	#include <emissivemap_fragment>\r
\r
\r
	// 增加多图层混合\r
    diffuseColor *= texture2D( map, vUv );\r
	vec4 map1Color = texture2D(map1, vUv);\r
	diffuseColor.rgb = diffuseColor.rgb * (1.0 - map1Color.a) + map1Color.rgb * map1Color.a;\r
    diffuseColor.a = opacity;\r
    \r
	// 未加载纹理图片时显示白色（网格）\r
	vec2 size = vec2(textureSize(map, 0));\r
	if(size.x<2.0){\r
		diffuseColor = vec4(1.0, 1.0, 1.0, 0.3);		\r
	}\r
\r
	// accumulation\r
	#include <lights_lambert_fragment>\r
	#include <lights_fragment_begin>\r
	#include <lights_fragment_maps>\r
	#include <lights_fragment_end>\r
\r
	// modulation\r
	// #include <aomap_fragment>\r
\r
\r
\r
	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\r
\r
	#include <envmap_fragment>\r
	#include <output_fragment>\r
	#include <tonemapping_fragment>\r
	#include <encodings_fragment>\r
	#include <fog_fragment>\r
	#include <premultiplied_alpha_fragment>\r
	#include <dithering_fragment>\r
\r
}`,Ze=`\r
#define LAMBERT\r
\r
varying vec3 vViewPosition;\r
varying vec2 vUv;\r
\r
#include <common>\r
#include <uv_pars_vertex>\r
#include <displacementmap_pars_vertex>\r
#include <envmap_pars_vertex>\r
#include <color_pars_vertex>\r
#include <fog_pars_vertex>\r
#include <normal_pars_vertex>\r
#include <morphtarget_pars_vertex>\r
#include <skinning_pars_vertex>\r
#include <shadowmap_pars_vertex>\r
#include <logdepthbuf_pars_vertex>\r
#include <clipping_planes_pars_vertex>\r
\r
void main() {\r
\r
	#include <uv_vertex>\r
\r
	vUv = vec3( uv, 1 ).xy;\r
\r
	#include <color_vertex>\r
	#include <morphcolor_vertex>\r
\r
	#include <beginnormal_vertex>\r
	#include <morphnormal_vertex>\r
	#include <skinbase_vertex>\r
	#include <skinnormal_vertex>\r
	#include <defaultnormal_vertex>\r
	#include <normal_vertex>\r
\r
	#include <begin_vertex>\r
	#include <morphtarget_vertex>\r
	#include <skinning_vertex>\r
	#include <displacementmap_vertex>\r
\r
	// 增加dem数据\r
	#ifdef USE_DISPLACEMENTMAP\r
		vec4 heightColor = texture2D(displacementMap, vUv);\r
		// mapBox高程\r
		float h = ((heightColor.r * 255.0 * 65536.0 + heightColor.g * 255.0 * 256.0 + heightColor.b * 255.0) * 0.1)*heightColor.a - 10000.0;\r
		transformed += normalize( objectNormal ) * h / 1000.0;\r
	#endif\r
\r
\r
	#include <project_vertex>\r
	#include <logdepthbuf_vertex>\r
	#include <clipping_planes_vertex>\r
\r
	vViewPosition = - mvPosition.xyz;\r
\r
	#include <worldpos_vertex>\r
	#include <envmap_vertex>\r
	#include <shadowmap_vertex>\r
	#include <fog_vertex>\r
\r
}`;class Ne extends a.ShaderMaterial{constructor(e){super({uniforms:a.UniformsUtils.merge([a.ShaderLib.lambert.uniforms,{map1:{value:null},diffuse:{value:new a.Color(16777215)}}]),vertexShader:Ze,fragmentShader:Ge,lights:!0,transparent:e.transparent||!0,wireframe:e.wireframe||!1,fog:!0}),this.uniforms.map.value=e.map,this.uniforms.map1.value=e.map1,this.defineProperty("map1"),this.defineProperty("diffuse"),this.defineProperty("opacity")}dispose(){this.uniforms.map.value?.dispose(),this.uniforms.map1.value?.dispose(),super.dispose()}defineProperty(e){Object.defineProperty(this,e,{get:function(){return this.uniforms[e].value},set:function(r){this.uniforms[e].value=r}})}}class He extends a.PlaneGeometry{build(e,r){this.dispose(),this.copy(new a.PlaneGeometry(1,1,r-1,r-1));const t=this.getAttribute("position");for(let i=0;i<t.count;i++)t.setZ(i,e[i])}setData(e,r){if(e.length!=r*r)throw"DEM array size error!";return this.build(e,r),this.computeBoundingBox(),this.computeBoundingSphere(),this.computeVertexNormals(),this}}class de extends a.PlaneGeometry{_min=1/0;build(e,r){this.dispose();const t=1,i=1,o=r-1,c=r-1,l=t/2,d=i/2;let h=Math.floor(o),u=Math.floor(c);const L=t/h,_=i/u;h+=2,u+=2;const g=h+1,S=u+1,T=[],A=[],C=[],D=[];let j=0;this._min=Math.min(...Array.from(e));for(let y=0;y<S;y++)for(let p=0;p<g;p++){let P=(p-1)*L-l,k=(y-1)*_-d,O=(p-1)/(h-2),M=1-(y-1)/(u-2);P=a.MathUtils.clamp(P,-.5,.5),k=a.MathUtils.clamp(k,-.5,.5),O=a.MathUtils.clamp(O,0,1),M=a.MathUtils.clamp(M,0,1);let R=0;y===0||y===S-1||p===0||p===g-1?R=this._min-.1:(R=e[j],j++),A.push(P,-k,R),C.push(0,0,1),D.push(O,M)}for(let y=0;y<u;y++)for(let p=0;p<h;p++){const P=p+g*y,k=p+g*(y+1),O=p+1+g*(y+1),M=p+1+g*y;T.push(P,k,M),T.push(k,O,M)}return this.setIndex(T),this.setAttribute("position",new a.Float32BufferAttribute(A,3)),this.setAttribute("normal",new a.Float32BufferAttribute(C,3)),this.setAttribute("uv",new a.Float32BufferAttribute(D,2)),this}setData(e,r){if(e.length!=r*r)throw"DEM array size error!";return this.build(e,r),this.computeBoundingBox(),this.computeBoundingSphere(),this.computeVertexNormals(),this}computeVertexNormals(){super.computeVertexNormals();const e=this.index,r=this.getAttribute("position"),t=this.getAttribute("normal"),i=new a.Vector3,o=new a.Vector3,c=new a.Vector3,l=new a.Vector3(0,0,1);function d(h){return t.setXYZ(h,l.x,l.y,l.z)}if(e)for(let h=0,u=e.count;h<u;h+=3){const L=e.getX(h+0),_=e.getX(h+1),g=e.getX(h+2);i.fromBufferAttribute(r,L),o.fromBufferAttribute(r,_),c.fromBufferAttribute(r,g),(i.z<this._min||o.z<this._min||c.z<this._min)&&(d(L),d(_),d(g))}t.needsUpdate=!0}}class N{static enabled=!0;static size=500;static files=new Map;static add(e,r){if(!this.enabled||this.files.has(e))return;this.files.set(e,r);const t=Array.from(this.files.keys()),i=this.files.size-this.size;for(let o=0;o<i;o++)this.remove(t[o]);console.assert(this.files.size<=this.size)}static get(e){if(this.enabled)return this.files.get(e)}static remove(e){this.files.delete(e)}static clear(){this.files.clear()}}class Ye extends Error{response;constructor(e,r){super(e),this.response=r}}class ue extends a.Loader{mimeType;responseType;constructor(e){super(e)}load(e,r,t,i,o){this.path!==void 0&&(e=this.path+e),e=this.manager.resolveURL(e);const c=N.get(e);if(c)return this.manager.itemStart(e),setTimeout(()=>{r&&r(c),this.manager.itemEnd(e)}),c;if(o?.aborted){console.log("aborted befor load");return}const l=new Request(e,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin",signal:o}),d=this.mimeType,h=this.responseType;fetch(l).then(u=>{if(u.status===200||u.status===0)return u.status===0&&console.warn("THREE.FileLoader: HTTP Status 0 received."),u;throw new Ye(`fetch for "${u.url}" responded with ${u.status}: ${u.statusText}`,u)}).then(u=>{switch(h){case"arraybuffer":return u.arrayBuffer();case"blob":return u.blob();case"document":return u.text().then(L=>new DOMParser().parseFromString(L,d));case"json":return u.json();default:if(d===void 0)return u.text();{const _=/charset="?([^;"\s]*)"?/i.exec(d),g=_&&_[1]?_[1].toLowerCase():void 0,S=new TextDecoder(g);return u.arrayBuffer().then(T=>S.decode(T))}}}).then(u=>{N.add(e,u),r&&r(u)}).catch(u=>{i&&i(u),u.name!="AbortError"&&this.manager.itemError(e)}).finally(()=>{this.manager.itemEnd(e)}),this.manager.itemStart(e)}setResponseType(e){return this.responseType=e,this}setMimeType(e){return this.mimeType=e,this}}class v{static manager=new a.LoadingManager;static demLoaderMap=new Map;static imgLoaderMap=new Map;static registerMaterialLoader(e){v.imgLoaderMap.set(e.dataType,e),console.log(`* Register imageLoader: ${e.dataType}`)}static registerGeometryLoader(e){v.demLoaderMap.set(e.dataType,e),console.log(`* Register terrainLoader: ${e.dataType}`)}static getMaterialLoader(e){const r=v.imgLoaderMap.get(e.dataType);if(r)return r;throw`Source dataType "${e.dataType}" is not support!`}static getGeometryLoader(e){const r=v.demLoaderMap.get(e.dataType);if(r)return r;throw`Source dataType "${e.dataType}" is not support!`}}const We="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";class X extends a.Loader{loader=new ue(v.manager);constructor(e){super(e),this.loader.setResponseType("blob")}load(e,r,t,i,o){const c=new Image,l=u=>{h(),r&&r(c)},d=u=>{h(),i&&i(u),c.src=We},h=()=>{c.removeEventListener("load",l,!1),c.removeEventListener("error",d,!1)};return c.addEventListener("load",l,!1),c.addEventListener("error",d,!1),this.crossOrigin,this.requestHeader,this.loader.load(e,u=>{r&&(c.src=URL.createObjectURL(u))},t,i,o),c}}function q(s,e){s.translate(new a.Vector2(.5,.5));const r=Math.floor(s.min.x*e),t=Math.floor(s.min.y*e),i=Math.floor((s.max.x-s.min.x)*e),o=Math.floor((s.max.y-s.min.y)*e);return{sx:r,sy:t,sw:i,sh:o}}function $e(s,e){if(s.width<=e)return s;const r=document.createElement("canvas"),t=r.getContext("2d");r.width=e,r.height=e;const i=e-2;t.drawImage(s,0,0,s.width,s.height,1,1,i,i);const o=t.getImageData(1,1,i,i);return t.putImageData(o,0,0),r}function Q(s,e){if(e.coord.z<=s.maxLevel)return{url:s.getTileUrl(e.coord.x,e.coord.y,e.coord.z),rect:new a.Box2(new a.Vector2(-.5,-.5),new a.Vector2(.5,.5))};function r(o,c){const l=new a.Vector3,d=new a.Vector2(1,1);for(;o.coord.z>c&&(l.applyMatrix4(o.matrix),d.multiplyScalar(.5),o.parent instanceof G);)o=o.parent;l.setY(-l.y);const h=new a.Box2().setFromCenterAndSize(new a.Vector2(l.x,l.y),d);return{tile:o,rect:h}}const t=r(e,s.maxLevel);return{url:s.getTileUrl(t.tile.coord.x,t.tile.coord.y,t.tile.coord.z),rect:t.rect}}class x{dataType="image";attribution="ThreeTile";minLevel=0;maxLevel=19;projection="3857";url="";subdomains=[];s="";colorSpace="srgb";opacity=1;bounds=[-180,85.05112877980659,180,-85.05112877980659];onGetUrl;constructor(e){e&&(Object.assign(this,e),e.url instanceof Function?this.getUrl=e.url:this.url=e.url||"")}getTileUrl(e,r,t){const i=this.subdomains.length;if(i>0){const c=Math.floor(Math.random()*i);this.s=this.subdomains[c]}const o=this.onGetUrl?this.onGetUrl(e,r,t):{x:e,y:r,z:t};if(o)return this.getUrl(o.x,o.y,o.z)}getUrl(e,r,t){if(this.url){const i=Object.assign({},this,{x:e,y:r,z:t});return Ke(this.url,i)}}static create(e){return new x(e)}}function Ke(s,e){const r=/\{ *([\w_ -]+) *\}/g;return s.replace(r,(t,i)=>{let o=e[i];if(o===void 0)throw new Error(`source url template error, No value provided for variable: ${t}`);return typeof o=="function"&&(o=o(e)),o})}class me extends a.Loader{get cacheSize(){return N.size}set cacheSize(e){N.size=e}_imgSource;get imgSource(){return this._imgSource}set imgSource(e){this._imgSource=e}_demSource;get demSource(){return this._demSource}set demSource(e){this._demSource=e}constructor(e,r){super(v.manager),this.imgSource=e||[x.create({dataType:"test"})],this.demSource=r}load(e,r,t){if(this.imgSource.length===0)throw new Error("imgSource can not be empty");const i=()=>{if(o&&c){for(let h=0;h<d.length;h++)l.addGroup(0,1/0,h);r()}};let o=!1,c=!1;const l=this.loadGeometry(e,()=>{o=!0,i()},t),d=this.loadMaterial(e,()=>{c=!0,i()},t);return e.geometry=l,e.material=d,{geometry:l,material:d}}loadGeometry(e,r,t){let i;return this.demSource?i=v.getGeometryLoader(this.demSource).load(this.demSource,e,r,t):(i=new a.PlaneGeometry,setTimeout(r)),i}loadMaterial(e,r,t){const i=this.imgSource.map(o=>{const l=v.getMaterialLoader(o).load(o,e,()=>{l.userData.loaded=!0,i.every(d=>d.userData.loaded)&&r()},t);return l});return i}}const Xe=new a.Texture;class he{loader=new X(v.manager);load(e,r,t,i){const{url:o,rect:c}=Q(e,r);if(!o)return setTimeout(t),Xe;const l=new a.Texture(new Image);return l.colorSpace=e.colorSpace,this.loader.load(o,d=>{r.coord.z>e.maxLevel?l.image=qe(d,c):l.image=d,l.needsUpdate=!0,t()},void 0,i,r.abortSignal),l}}function qe(s,e){const r=s.width,t=new OffscreenCanvas(r,r),i=t.getContext("2d"),{sx:o,sy:c,sw:l,sh:d}=q(e,s.width);return i.drawImage(s,o,c,l,d,0,0,r,r),t}class Qe{dataType="image";load(e,r,t,i){const o=h=>{const u=h.target;u.map?.image instanceof ImageBitmap&&u.map.image.close(),u.map?.dispose(),u.removeEventListener("dispose",o)},c=this.createMaterial();c.opacity=e.opacity,c.addEventListener("dispose",o);const d=new he().load(e,r,()=>{c.map=d,d.needsUpdate=!0,t()},h=>{i(h)});return c}createMaterial(){return new a.MeshLambertMaterial({transparent:!0})}}v.registerMaterialLoader(new Qe);const Je=new a.BufferGeometry;class et extends a.Loader{dataType="terrain-rgb";imageLoader=new X(v.manager);load(e,r,t,i){if(r.coord.z<8)return setTimeout(t),new a.PlaneGeometry;const{url:o,rect:c}=Q(e,r);return o?this._load(r,o,c,t,i):(setTimeout(t),Je)}_load(e,r,t,i,o){let c=e.coord.z*3;c=Math.min(Math.max(c,2),48);const l=new de;return this.imageLoader.load(r,d=>{const{data:h,size:u}=it(d,c,t);l.setData(rt(h),u),i()},void 0,o,e.abortSignal),l}}function tt(s,e){const r=s[e*4],t=s[e*4+1],i=s[e*4+2];return(((r<<16)+(t<<8)+i)*.1-1e4)/1e3}function rt(s){const e=Math.floor(s.length/4),r=new Float32Array(e);for(let t=0;t<r.length;t++)r[t]=tt(s,t);return r}function it(s,e,r){const i=new OffscreenCanvas(e,e).getContext("2d");i.imageSmoothingEnabled=!1;const o=q(r,s.width);return e>o.sw&&(e=o.sw),i.drawImage(s,o.sx,o.sy,o.sw,o.sh,0,0,e,e),{data:i.getImageData(0,0,e,e).data,size:e}}v.registerGeometryLoader(new et);class U{isWGS=!1;static createFromID(e="3857"){let r;switch(e){case"3857":r=new ee;break;case"4326":r=new pe;break}return r}static createFromSource(e){let r="3857";return e&&(r=e.projection),U.createFromID(r)}}const J=6378;class ee extends U{ID="3857";isWGS=!1;mapWidth=2*Math.PI*J;mapHeight=this.mapWidth;mapDepth=1;project(e,r,t){const i=J;let o=(e-t)*Math.PI/180*i;o>this.mapWidth/2&&(o=o-this.mapWidth);const c=Math.log(Math.tan(Math.PI/4+r*Math.PI/180/2))*i;return{x:o,y:c}}unProject(e,r,t){const i=J,o=(e/i/Math.PI*180+t+540)%360-180;return{lat:(Math.atan(Math.exp(r/i))*2-Math.PI/2)*180/Math.PI,lon:o}}}class pe extends U{ID="4326";isWGS=!0;mapWidth=36e3;mapHeight=18e3;mapDepth=1;project(e,r,t){return{x:(e-t)*100,y:r*100}}unProject(e,r,t){return{lon:e/100+t,lat:r/100}}}const nt=new a.Vector3(0,0,-1);function fe(s,e){const r=e.intersectObjects([s.rootTile]);for(const t of r)if(t.object instanceof G){const i=s.worldToLocal(t.point),o=s.pos2geo(i);return Object.assign(t,{location:o})}}function ge(s,e){const r=new a.Vector3(e.x,e.y,10),t=new a.Raycaster(r,nt);return fe(s,t)}function ot(s,e,r){const t=new a.Raycaster;return t.setFromCamera(r,s),fe(e,t)}class te extends a.Mesh{_clock=new a.Clock;isLOD=!0;autoUpdate=!0;rootTile;loader;get minLevel(){return this.rootTile.minLevel}set minLevel(e){this.rootTile.minLevel=e}get maxLevel(){return this.rootTile.maxLevel}set maxLevel(e){this.rootTile.maxLevel=e}get autoLoad(){return this.rootTile.autoLoad}set autoLoad(e){this.rootTile.autoLoad=e}_autoAdjustZ=!1;get autoAdjustZ(){return this._autoAdjustZ}set autoAdjustZ(e){this._autoAdjustZ=e}get loadCacheSize(){return this.loader.cacheSize}set loadCacheSize(e){this.loader.cacheSize=e}get viewerBufferSize(){return this.rootTile.viewerbufferSize*2}set viewerBufferSize(e){this.rootTile.viewerbufferSize=e/2}get maxZInView(){return this.rootTile.maxZ}get minZInView(){return this.rootTile.minZ}get avgZInView(){return this.rootTile.avgZ}_centralMeridian=0;get centralMeridian(){return this._centralMeridian}set centralMeridian(e){e!=0&&this.rootTile.minLevel<1&&console.warn(`Map centralMeridian is ${this.centralMeridian}, minLevel must > 0`),this._centralMeridian=e,this.reload()}_projection=new ee;get projection(){return this._projection}set projection(e){this.rootTile.scale.set(e.mapWidth,e.mapHeight,e.mapDepth),e.ID!=this.projection.ID&&(this.rootTile.isWGS=e.isWGS,this._projection=e,this.reload(),console.log("Map Projection Changed:",e.ID),this.dispatchEvent({type:"projection-changed",projection:e}))}get imgSource(){return this.loader.imgSource}set imgSource(e){this.loader.imgSource=Array.isArray(e)?e:[e],this._setMapProjection(),this._setTileCoordConvert(),this.dispatchEvent({type:"source-changed",source:e})}get demSource(){return this.loader.demSource}set demSource(e){this.loader.demSource=e,this._setTileCoordConvert(),this.dispatchEvent({type:"source-changed",source:e})}get LODThreshold(){return this.rootTile.LODThreshold}set LODThreshold(e){this.rootTile.LODThreshold=e}static create(e){let r=e.imgSource;Array.isArray(r)||(r=[r]);const t=new me(r,e.demSource),i=new K(t,0,0,0);return new te({loader:t,rootTile:i,centralMeridian:e.centralMeridian,minLevel:e.minLevel,maxLevel:e.maxLevel})}constructor(e){super(),this.loader=e.loader,this.rootTile=e.rootTile||new K(this.loader),this.rootTile.minLevel=e.minLevel||0,this.rootTile.maxLevel=e.maxLevel||18,this.projection=U.createFromSource(this.loader.imgSource[0]||"3857"),this.centralMeridian=e.centralMeridian||0,this._setTileCoordConvert(),this._attachEvent(),this.add(this.rootTile),this.rootTile.updateMatrix(),this.rootTile.updateMatrixWorld()}_setTileCoordConvert(){const e=this;function r(t,i,o){const c=Math.pow(2,o);let l=t+Math.round(c/360*e.centralMeridian);return l>=c?l-=c:l<0&&(l+=c),{x:l,y:i,z:o}}this.loader.imgSource.forEach(t=>{t.onGetUrl||(t.onGetUrl=r)}),this.loader.demSource&&(this.loader.demSource.onGetUrl=r)}_setMapProjection(){const e=this.loader.imgSource[0].projection;this.projection.ID!=e&&(this.projection=U.createFromID(e))}update(e){this.rootTile.receiveShadow=this.receiveShadow,this.rootTile.castShadow=this.castShadow,this.autoAdjustZ&&this.position.setZ((this.position.z-this.avgZInView/100)/1.03),this.rootTile.update(e),this.dispatchEvent({type:"update",delta:this._clock.getDelta()})}reload(){this.rootTile.dispose(!0),this.position.setZ(0)}dispose(){this.removeFromParent(),this.reload()}get attributions(){const e=[];let r=this.imgSource;if(Array.isArray(r)||(r=[r]),r.forEach(t=>{const i=t.attribution;i&&e.push(i)}),this.demSource){const t=this.demSource.attribution;t&&e.push(t)}return Array.from(new Set(e))}geo2pos(e){const r=this._projection.project(e.x,e.y,this.centralMeridian);return new a.Vector3(r.x,r.y,e.z)}pos2geo(e){const r=this._projection.unProject(e.x,e.y,this.centralMeridian);return new a.Vector3(r.lon,r.lat,e.z)}getLocalInfoFromGeo(e){const r=this.geo2pos(e);return ge(this,r)}getLocalInfoFromWorld(e){return ge(this,e)}getLocalInfoFromScreen(e,r){return ot(e,this,r)}getTileCount(){let e=0,r=0,t=0,i=0;return this.rootTile.traverse(o=>{o.isTile&&(e++,o.isLeafInFrustum&&r++,o.isLeaf&&i++,t=Math.max(t,o.coord.z))}),{total:e,visible:r,leaf:i,maxLevle:t}}_attachEvent(){const e=this.loader.manager;return e.onStart=(r,t,i)=>{this.dispatchEvent({type:"loading-start",itemsLoaded:t,itemsTotal:i})},e.onError=r=>{this.dispatchEvent({type:"loading-error",url:r})},e.onLoad=()=>{this.dispatchEvent({type:"loading-complete"})},e.onProgress=(r,t,i)=>{this.dispatchEvent({type:"loading-progress",url:r,itemsLoaded:t,itemsTotal:i})},this.rootTile.addEventListener("tile-created",r=>{this.dispatchEvent({type:"tile-created",tile:r.tile})}),this.rootTile.addEventListener("tile-loaded",r=>{this.dispatchEvent({type:"tile-loaded",tile:r.tile})}),this.rootTile.addEventListener("loaded",()=>{this.dispatchEvent({type:"loaded"})}),this}}class at{dataType="debug";load(e,r,t,i){const o=d=>{const h=d.target;h.map?.image instanceof ImageBitmap&&h.map.image.close(),h.map?.dispose(),h.removeEventListener("dispose",o)},c=new a.CanvasTexture(this.drawTile(r));c.needsUpdate=!0;const l=new a.MeshBasicMaterial({transparent:!0,map:c,opacity:e.opacity});return l.addEventListener("dispose",o),setTimeout(t),l}drawTile(e){const t=new OffscreenCanvas(256,256),i=t.getContext("2d");return i.scale(1,-1),i.translate(0,-256),i&&(i.strokeStyle="#ccc",i.lineWidth=4,i.strokeRect(5,5,256-10,256-10),i.fillStyle="white",i.shadowColor="black",i.shadowBlur=5,i.shadowOffsetX=1,i.shadowOffsetY=1,i.font="bold 20px arial",i.textAlign="center",i.fillText(`Tile Test - level: ${e.coord.z}`,256/2,50),i.fillText(`[${e.coord.x}, ${e.coord.y}]`,256/2,80)),t.transferToImageBitmap()}}v.registerMaterialLoader(new at);class st{dataType="logo";load(e,r,t,i){if(r.coord.z<4)return setTimeout(t),new a.MeshBasicMaterial;const o=new a.Texture(this.drawLogo(e.attribution));o.needsUpdate=!0;const c=new a.MeshBasicMaterial({transparent:!0,map:o,opacity:e.opacity}),l=d=>{const h=d.target;h.map?.image instanceof ImageBitmap&&h.map.image.close(),h.map?.dispose(),h.removeEventListener("dispose",l)};return c.addEventListener("dispose",l),setTimeout(t),c}drawLogo(e){const t=new OffscreenCanvas(256,256),i=t.getContext("2d");return i.scale(1,-1),i.translate(0,-256),i&&(i.fillStyle="white",i.shadowColor="black",i.shadowBlur=5,i.shadowOffsetX=1,i.shadowOffsetY=1,i.font="bold 14px arial",i.textAlign="center",i.translate(256/2,256/2),i.rotate(30*Math.PI/180),i.fillText(`${e}`,0,0)),t.transferToImageBitmap()}}v.registerMaterialLoader(new st);class ct{dataType="normal";load(e,r,t,i){const o=new a.MeshNormalMaterial({transparent:!0,opacity:e.opacity,flatShading:!0});return setTimeout(t),o}}v.registerMaterialLoader(new ct);class lt{dataType="wireframe";load(e,r,t,i){const o=new a.Color(`hsl(${r.coord.z*14}, 100%, 50%)`),c=new a.MeshBasicMaterial({transparent:!0,wireframe:!0,color:o,opacity:e.opacity});return setTimeout(t),c}}v.registerMaterialLoader(new lt);const ye={type:"change"},re={type:"start"},ve={type:"end"};class dt extends a.EventDispatcher{constructor(e,r){super(),this.object=e,this.domElement=r,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new a.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:a.MOUSE.ROTATE,MIDDLE:a.MOUSE.DOLLY,RIGHT:a.MOUSE.PAN},this.touches={ONE:a.TOUCH.ROTATE,TWO:a.TOUCH.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return l.phi},this.getAzimuthalAngle=function(){return l.theta},this.getDistance=function(){return this.object.position.distanceTo(this.target)},this.listenToKeyEvents=function(n){n.addEventListener("keydown",oe),this._domElementKeyEvents=n},this.stopListenToKeyEvents=function(){this._domElementKeyEvents.removeEventListener("keydown",oe),this._domElementKeyEvents=null},this.saveState=function(){t.target0.copy(t.target),t.position0.copy(t.object.position),t.zoom0=t.object.zoom},this.reset=function(){t.target.copy(t.target0),t.object.position.copy(t.position0),t.object.zoom=t.zoom0,t.object.updateProjectionMatrix(),t.dispatchEvent(ye),t.update(),o=i.NONE},this.update=function(){const n=new a.Vector3,m=new a.Quaternion().setFromUnitVectors(e.up,new a.Vector3(0,1,0)),b=m.clone().invert(),w=new a.Vector3,E=new a.Quaternion,B=2*Math.PI;return function(){const ze=t.object.position;n.copy(ze).sub(t.target),n.applyQuaternion(m),l.setFromVector3(n),t.autoRotate&&o===i.NONE&&M(k()),t.enableDamping?(l.theta+=d.theta*t.dampingFactor,l.phi+=d.phi*t.dampingFactor):(l.theta+=d.theta,l.phi+=d.phi);let I=t.minAzimuthAngle,z=t.maxAzimuthAngle;return isFinite(I)&&isFinite(z)&&(I<-Math.PI?I+=B:I>Math.PI&&(I-=B),z<-Math.PI?z+=B:z>Math.PI&&(z-=B),I<=z?l.theta=Math.max(I,Math.min(z,l.theta)):l.theta=l.theta>(I+z)/2?Math.max(I,l.theta):Math.min(z,l.theta)),l.phi=Math.max(t.minPolarAngle,Math.min(t.maxPolarAngle,l.phi)),l.makeSafe(),l.radius*=h,l.radius=Math.max(t.minDistance,Math.min(t.maxDistance,l.radius)),t.enableDamping===!0?t.target.addScaledVector(u,t.dampingFactor):t.target.add(u),n.setFromSpherical(l),n.applyQuaternion(b),ze.copy(t.target).add(n),t.object.lookAt(t.target),t.enableDamping===!0?(d.theta*=1-t.dampingFactor,d.phi*=1-t.dampingFactor,u.multiplyScalar(1-t.dampingFactor)):(d.set(0,0,0),u.set(0,0,0)),h=1,L||w.distanceToSquared(t.object.position)>c||8*(1-E.dot(t.object.quaternion))>c?(t.dispatchEvent(ye),w.copy(t.object.position),E.copy(t.object.quaternion),L=!1,!0):!1}}(),this.dispose=function(){t.domElement.removeEventListener("contextmenu",je),t.domElement.removeEventListener("pointerdown",Ce),t.domElement.removeEventListener("pointercancel",Z),t.domElement.removeEventListener("wheel",De),t.domElement.removeEventListener("pointermove",ne),t.domElement.removeEventListener("pointerup",Z),t._domElementKeyEvents!==null&&(t._domElementKeyEvents.removeEventListener("keydown",oe),t._domElementKeyEvents=null)};const t=this,i={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let o=i.NONE;const c=1e-6,l=new a.Spherical,d=new a.Spherical;let h=1;const u=new a.Vector3;let L=!1;const _=new a.Vector2,g=new a.Vector2,S=new a.Vector2,T=new a.Vector2,A=new a.Vector2,C=new a.Vector2,D=new a.Vector2,j=new a.Vector2,y=new a.Vector2,p=[],P={};function k(){return 2*Math.PI/60/60*t.autoRotateSpeed}function O(){return Math.pow(.95,t.zoomSpeed)}function M(n){d.theta-=n}function R(n){d.phi-=n}const _e=function(){const n=new a.Vector3;return function(b,w){n.setFromMatrixColumn(w,0),n.multiplyScalar(-b),u.add(n)}}(),we=function(){const n=new a.Vector3;return function(b,w){t.screenSpacePanning===!0?n.setFromMatrixColumn(w,1):(n.setFromMatrixColumn(w,0),n.crossVectors(t.object.up,n)),n.multiplyScalar(b),u.add(n)}}(),F=function(){const n=new a.Vector3;return function(b,w){const E=t.domElement;if(t.object.isPerspectiveCamera){const B=t.object.position;n.copy(B).sub(t.target);let H=n.length();H*=Math.tan(t.object.fov/2*Math.PI/180),_e(2*b*H/E.clientHeight,t.object.matrix),we(2*w*H/E.clientHeight,t.object.matrix)}else t.object.isOrthographicCamera?(_e(b*(t.object.right-t.object.left)/t.object.zoom/E.clientWidth,t.object.matrix),we(w*(t.object.top-t.object.bottom)/t.object.zoom/E.clientHeight,t.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),t.enablePan=!1)}}();function ie(n){t.object.isPerspectiveCamera?h/=n:t.object.isOrthographicCamera?(t.object.zoom=Math.max(t.minZoom,Math.min(t.maxZoom,t.object.zoom*n)),t.object.updateProjectionMatrix(),L=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),t.enableZoom=!1)}function xe(n){t.object.isPerspectiveCamera?h*=n:t.object.isOrthographicCamera?(t.object.zoom=Math.max(t.minZoom,Math.min(t.maxZoom,t.object.zoom/n)),t.object.updateProjectionMatrix(),L=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),t.enableZoom=!1)}function Te(n){_.set(n.clientX,n.clientY)}function Dt(n){D.set(n.clientX,n.clientY)}function Le(n){T.set(n.clientX,n.clientY)}function jt(n){g.set(n.clientX,n.clientY),S.subVectors(g,_).multiplyScalar(t.rotateSpeed);const m=t.domElement;M(2*Math.PI*S.x/m.clientHeight),R(2*Math.PI*S.y/m.clientHeight),_.copy(g),t.update()}function It(n){j.set(n.clientX,n.clientY),y.subVectors(j,D),y.y>0?ie(O()):y.y<0&&xe(O()),D.copy(j),t.update()}function zt(n){A.set(n.clientX,n.clientY),C.subVectors(A,T).multiplyScalar(t.panSpeed),F(C.x,C.y),T.copy(A),t.update()}function kt(n){n.deltaY<0?xe(O()):n.deltaY>0&&ie(O()),t.update()}function Rt(n){let m=!1;switch(n.code){case t.keys.UP:n.ctrlKey||n.metaKey||n.shiftKey?R(2*Math.PI*t.rotateSpeed/t.domElement.clientHeight):F(0,t.keyPanSpeed),m=!0;break;case t.keys.BOTTOM:n.ctrlKey||n.metaKey||n.shiftKey?R(-2*Math.PI*t.rotateSpeed/t.domElement.clientHeight):F(0,-t.keyPanSpeed),m=!0;break;case t.keys.LEFT:n.ctrlKey||n.metaKey||n.shiftKey?M(2*Math.PI*t.rotateSpeed/t.domElement.clientHeight):F(t.keyPanSpeed,0),m=!0;break;case t.keys.RIGHT:n.ctrlKey||n.metaKey||n.shiftKey?M(-2*Math.PI*t.rotateSpeed/t.domElement.clientHeight):F(-t.keyPanSpeed,0),m=!0;break}m&&(n.preventDefault(),t.update())}function Me(){if(p.length===1)_.set(p[0].pageX,p[0].pageY);else{const n=.5*(p[0].pageX+p[1].pageX),m=.5*(p[0].pageY+p[1].pageY);_.set(n,m)}}function Se(){if(p.length===1)T.set(p[0].pageX,p[0].pageY);else{const n=.5*(p[0].pageX+p[1].pageX),m=.5*(p[0].pageY+p[1].pageY);T.set(n,m)}}function Ee(){const n=p[0].pageX-p[1].pageX,m=p[0].pageY-p[1].pageY,b=Math.sqrt(n*n+m*m);D.set(0,b)}function Ut(){t.enableZoom&&Ee(),t.enablePan&&Se()}function Vt(){t.enableZoom&&Ee(),t.enableRotate&&Me()}function Ae(n){if(p.length==1)g.set(n.pageX,n.pageY);else{const b=ae(n),w=.5*(n.pageX+b.x),E=.5*(n.pageY+b.y);g.set(w,E)}S.subVectors(g,_).multiplyScalar(t.rotateSpeed);const m=t.domElement;M(2*Math.PI*S.x/m.clientHeight),R(2*Math.PI*S.y/m.clientHeight),_.copy(g)}function Pe(n){if(p.length===1)A.set(n.pageX,n.pageY);else{const m=ae(n),b=.5*(n.pageX+m.x),w=.5*(n.pageY+m.y);A.set(b,w)}C.subVectors(A,T).multiplyScalar(t.panSpeed),F(C.x,C.y),T.copy(A)}function Oe(n){const m=ae(n),b=n.pageX-m.x,w=n.pageY-m.y,E=Math.sqrt(b*b+w*w);j.set(0,E),y.set(0,Math.pow(j.y/D.y,t.zoomSpeed)),ie(y.y),D.copy(j)}function Ft(n){t.enableZoom&&Oe(n),t.enablePan&&Pe(n)}function Bt(n){t.enableZoom&&Oe(n),t.enableRotate&&Ae(n)}function Ce(n){t.enabled!==!1&&(p.length===0&&(t.domElement.setPointerCapture(n.pointerId),t.domElement.addEventListener("pointermove",ne),t.domElement.addEventListener("pointerup",Z)),Yt(n),n.pointerType==="touch"?Nt(n):Gt(n))}function ne(n){t.enabled!==!1&&(n.pointerType==="touch"?Ht(n):Zt(n))}function Z(n){Wt(n),p.length===0&&(t.domElement.releasePointerCapture(n.pointerId),t.domElement.removeEventListener("pointermove",ne),t.domElement.removeEventListener("pointerup",Z)),t.dispatchEvent(ve),o=i.NONE}function Gt(n){let m;switch(n.button){case 0:m=t.mouseButtons.LEFT;break;case 1:m=t.mouseButtons.MIDDLE;break;case 2:m=t.mouseButtons.RIGHT;break;default:m=-1}switch(m){case a.MOUSE.DOLLY:if(t.enableZoom===!1)return;Dt(n),o=i.DOLLY;break;case a.MOUSE.ROTATE:if(n.ctrlKey||n.metaKey||n.shiftKey){if(t.enablePan===!1)return;Le(n),o=i.PAN}else{if(t.enableRotate===!1)return;Te(n),o=i.ROTATE}break;case a.MOUSE.PAN:if(n.ctrlKey||n.metaKey||n.shiftKey){if(t.enableRotate===!1)return;Te(n),o=i.ROTATE}else{if(t.enablePan===!1)return;Le(n),o=i.PAN}break;default:o=i.NONE}o!==i.NONE&&t.dispatchEvent(re)}function Zt(n){switch(o){case i.ROTATE:if(t.enableRotate===!1)return;jt(n);break;case i.DOLLY:if(t.enableZoom===!1)return;It(n);break;case i.PAN:if(t.enablePan===!1)return;zt(n);break}}function De(n){t.enabled===!1||t.enableZoom===!1||o!==i.NONE||(n.preventDefault(),t.dispatchEvent(re),kt(n),t.dispatchEvent(ve))}function oe(n){t.enabled===!1||t.enablePan===!1||Rt(n)}function Nt(n){switch(Ie(n),p.length){case 1:switch(t.touches.ONE){case a.TOUCH.ROTATE:if(t.enableRotate===!1)return;Me(),o=i.TOUCH_ROTATE;break;case a.TOUCH.PAN:if(t.enablePan===!1)return;Se(),o=i.TOUCH_PAN;break;default:o=i.NONE}break;case 2:switch(t.touches.TWO){case a.TOUCH.DOLLY_PAN:if(t.enableZoom===!1&&t.enablePan===!1)return;Ut(),o=i.TOUCH_DOLLY_PAN;break;case a.TOUCH.DOLLY_ROTATE:if(t.enableZoom===!1&&t.enableRotate===!1)return;Vt(),o=i.TOUCH_DOLLY_ROTATE;break;default:o=i.NONE}break;default:o=i.NONE}o!==i.NONE&&t.dispatchEvent(re)}function Ht(n){switch(Ie(n),o){case i.TOUCH_ROTATE:if(t.enableRotate===!1)return;Ae(n),t.update();break;case i.TOUCH_PAN:if(t.enablePan===!1)return;Pe(n),t.update();break;case i.TOUCH_DOLLY_PAN:if(t.enableZoom===!1&&t.enablePan===!1)return;Ft(n),t.update();break;case i.TOUCH_DOLLY_ROTATE:if(t.enableZoom===!1&&t.enableRotate===!1)return;Bt(n),t.update();break;default:o=i.NONE}}function je(n){t.enabled!==!1&&n.preventDefault()}function Yt(n){p.push(n)}function Wt(n){delete P[n.pointerId];for(let m=0;m<p.length;m++)if(p[m].pointerId==n.pointerId){p.splice(m,1);return}}function Ie(n){let m=P[n.pointerId];m===void 0&&(m=new a.Vector2,P[n.pointerId]=m),m.set(n.pageX,n.pageY)}function ae(n){const m=n.pointerId===p[0].pointerId?p[1]:p[0];return P[m.pointerId]}t.domElement.addEventListener("contextmenu",je),t.domElement.addEventListener("pointerdown",Ce),t.domElement.addEventListener("pointercancel",Z),t.domElement.addEventListener("wheel",De,{passive:!1}),this.update()}}class ut extends dt{constructor(e,r){super(e,r),this.screenSpacePanning=!1,this.mouseButtons={LEFT:a.MOUSE.PAN,MIDDLE:a.MOUSE.DOLLY,RIGHT:a.MOUSE.ROTATE},this.touches={ONE:a.TOUCH.PAN,TWO:a.TOUCH.DOLLY_ROTATE}}}a.Object3D.DEFAULT_UP.set(0,0,1);class mt extends a.EventDispatcher{scene;renderer;camera;controls;ambLight;dirLight;container;_clock=new a.Clock;_fogFactor=1;get fogFactor(){return this._fogFactor}set fogFactor(e){this._fogFactor=e,this.controls.dispatchEvent({type:"change",target:this.controls})}get width(){return this.container.clientWidth}get height(){return this.container.clientHeight}constructor(e,r=new a.Vector3(0,3e3,0),t=new a.Vector3(0,-1e3,1e4)){super(),this.container=e,this.renderer=this._createRenderer(),this.scene=this._createScene(),this.camera=this._createCamera(t),this.controls=this._createControls(r,this.camera,e),this.ambLight=this._createAmbLight(),this.scene.add(this.ambLight),this.dirLight=this._createDirLight(),this.scene.add(this.dirLight),this.container.appendChild(this.renderer.domElement),window.addEventListener("resize",this.resize.bind(this)),this.resize(),this.animate()}_createScene(){const e=new a.Scene,r=14414079;return e.background=new a.Color(r),e.fog=new a.FogExp2(r,0),e}_createRenderer(){const e=new a.WebGLRenderer({antialias:!1,alpha:!0,logarithmicDepthBuffer:!0,precision:"highp"});return e.debug.checkShaderErrors=!0,e.toneMapping=0,e.sortObjects=!0,e.setPixelRatio(window.devicePixelRatio),e}_createCamera(e){const r=new a.PerspectiveCamera(70,1,.1,5e4);return r.position.copy(e),r}_createControls(e,r,t){const i=new ut(r,t);return i.target.copy(e),i.minDistance=.1,i.maxDistance=3e4,i.maxPolarAngle=1.1,i.enableDamping=!0,i.keyPanSpeed=5,i.listenToKeyEvents(window),i.addEventListener("change",()=>{const o=Math.max(this.controls.getPolarAngle(),.1),c=Math.max(this.controls.getDistance(),.1);i.zoomSpeed=Math.max(Math.log(c),1.8),this.camera.far=a.MathUtils.clamp(c/o*8,100,5e4),this.camera.near=this.camera.far/1e3,this.camera.updateProjectionMatrix(),this.scene.fog instanceof a.FogExp2&&(this.scene.fog.density=o/(c+5)/4*this.fogFactor),c>8e3?(i.minAzimuthAngle=0,i.maxAzimuthAngle=0):(i.minAzimuthAngle=-1/0,i.maxAzimuthAngle=1/0),i.maxPolarAngle=Math.min(Math.pow(1e4,4)/Math.pow(c,4),1.1)}),i.saveState(),i}_createAmbLight(){return new a.AmbientLight(16777215,.5)}_createDirLight(){const e=new a.DirectionalLight(16777215,.5);return e.target.position.copy(this.controls.target),e.position.set(-1e3,-2e3,1e4),e}resize(){const e=this.width,r=this.height;return this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(e,r),this.camera.aspect=e/r,this.camera.updateProjectionMatrix(),this}animate(){this.controls.update(),this.renderer.render(this.scene,this.camera),this.dispatchEvent({type:"update",delta:this._clock.getDelta()}),requestAnimationFrame(this.animate.bind(this))}}class ht extends x{token="";format="webp";style="mapbox.satellite";attribution="MapBox";maxLevel=19;url="https://api.mapbox.com/v4/{style}/{z}/{x}/{y}.{format}?access_token={token}";constructor(e){super(e),Object.assign(this,e)}}class pt extends x{dataType="image";attribution="ArcGIS";style="World_Imagery";url="https://services.arcgisonline.com/arcgis/rest/services/{style}/MapServer/tile/{z}/{y}/{x}";constructor(e){super(e),Object.assign(this,e)}}class ft extends x{dataType="lerc";attribution="ArcGIS";maxLevel=13;url="https://elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer/tile/{z}/{y}/{x}";constructor(e){super(e),Object.assign(this,e)}}class gt extends x{dataType="image";attribution="Bing[GS(2021)1731号]";style="A";mkt="zh-CN";subdomains="123";constructor(e){super(e),Object.assign(this,e)}getUrl(e,r,t){const i=yt(t,e,r);return`https://t${this.s}.dynamic.tiles.ditu.live.com/comp/ch/${i}?mkt=${this.mkt}&ur=CN&it=${this.style}&n=z&og=804&cstl=vb`}}function yt(s,e,r){let t="";for(let i=s;i>0;i--){const o=1<<i-1;let c=0;e&o&&c++,r&o&&(c+=2),t+=c}return t}class vt extends x{dataType="image";attribution="高德[GS(2021)6375号]";style="8";subdomains="1234";maxLevel=18;url="https://webst0{s}.is.autonavi.com/appmaptile?style={style}&x={x}&y={y}&z={z}";constructor(e){super(e),Object.assign(this,e)}}class bt extends x{dataType="image";maxLevel=16;attribution="GeoQ[GS(2019)758号]";style="ChinaOnlineStreetPurplishBlue";url="https://map.geoq.cn/ArcGIS/rest/services/{style}/MapServer/tile/{z}/{y}/{x}";constructor(e){super(e),Object.assign(this,e)}}class _t extends x{dataType="image";attribution="Google";maxLevel=20;style="y";subdomains="0123";url="http://mt{s}.google.com/vt/lyrs={style}&src=app&x={x}&y={y}&z={z}";constructor(e){super(e),Object.assign(this,e)}}class wt extends x{attribution="MapTiler";token="get_your_own_key_QmavnBrQwNGsQ8YvPzZg";format="jpg";style="satellite-v2";url="https://api.maptiler.com/tiles/{style}/{z}/{x}/{y}.{format}?key={token}";constructor(e){super(e),Object.assign(this,e)}}class xt extends x{dataType="image";attribution="Stadia";url="https://tiles.stadiamaps.com/tiles/alidade_satellite/{z}/{x}/{y}.jpg";constructor(e){super(e),Object.assign(this,e)}}class Tt extends x{dataType="image";attribution="天地图[GS(2023)336号]";token="";style="img_w";subdomains="01234";url="https://t{s}.tianditu.gov.cn/DataServer?T={style}&x={x}&y={y}&l={z}&tk={token}";constructor(e){super(e),Object.assign(this,e)}}class Lt extends x{dataType="image";style="sateTiles";attribution="腾讯[GS(2023)1号]";subdomains="0123";maxLevel=18;constructor(e){super(e),Object.assign(this,e)}getUrl(e,r,t){const i=e>>4,o=(1<<t)-r>>4,c=Math.pow(2,t)-1-r;return`https://p${this.s}.map.gtimg.com/${this.style}/${t}/${i}/${o}/${e}_${c}.jpg`}}class Mt extends x{attribution="中科星图[GS(2022)3995号]";token="";style="img";format="webp";subdomains="12";url="https://tiles{s}.geovisearth.com/base/v1/{style}/{z}/{x}/{y}?format={format}&tmsIds=w&token={token}";constructor(e){super(e),Object.assign(this,e)}}const St=`
varying vec2 vUv;
uniform vec3 bkColor;
uniform vec3 airColor;

void main() {  
    vUv = uv;
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);  
}  
`,Et=`



varying vec2 vUv;
uniform vec3 bkColor;
uniform vec3 airColor;

void main() {   

    // 当前点距中点的距离
    float d = distance(vUv, vec2(0.5f))*5.0f;
    
    if(d<0.47f){
        // 球体颜色(<0.48)
        float a = smoothstep(0.4f,0.0f,0.48f-d);     
        gl_FragColor = vec4(vec3(0.0f), a);               
    } else if(d<0.48){
        float c = (d-0.47f)/0.01f;
        gl_FragColor =vec4(mix(vec3(0.0f),airColor,c*c),1.0f);
    } else if(d<0.52f){
        // 光晕(0.48-0.52)
        float c = (d-0.48f)/0.04f;
        gl_FragColor = vec4(mix(airColor,bkColor,sqrt(c)),1.0);
    } else{
        // 球体外颜色
        gl_FragColor = vec4(bkColor,1.0f);
    }
    
    #include <tonemapping_fragment>
    #include <encodings_fragment>    
    
}  
`;class be extends a.ShaderMaterial{constructor(e){super({uniforms:a.UniformsUtils.merge([a.UniformsLib.fog,{bkColor:{value:e.bkColor},airColor:{value:e.airColor}}]),transparent:!0,depthTest:!1,vertexShader:St,fragmentShader:Et,lights:!1})}}class At extends a.Mesh{get bkColor(){return this.material.uniforms.bkColor.value}set bkColor(e){this.material.uniforms.bkColor.value.set(e)}constructor(e,r=new a.Color(6724044)){super(new a.PlaneGeometry(5,5),new be({bkColor:e,airColor:r})),this.renderOrder=999}}const Pt=Object.freeze(Object.defineProperty({__proto__:null,ArcGisDemSource:ft,ArcGisSource:pt,BingSource:gt,EarthMaskMaterial:be,FakeEarth:At,GDSource:vt,GLViewer:mt,GeoqSource:bt,GoogleSource:_t,MapBoxSource:ht,MapTilerSource:wt,StadiaSource:xt,TDTSource:Tt,TXSource:Lt,ZKXTSource:Mt},Symbol.toStringTag,{value:"Module"})),Ot=se.version,Ct=se.author;f.BaseSource=x,f.FileLoaderEx=ue,f.ImageLoaderEx=X,f.LoaderFactory=v,f.ProjMCT=ee,f.ProjWGS=pe,f.Projection=U,f.RootTile=K,f.Tile=G,f.TileGridGeometry=de,f.TileLoader=me,f.TileMap=te,f.TileMaterial=Ne,f.TileSimpleGeometry=He,f.TileTextureLoader=he,f.author=Ct,f.getSafeTileUrlAndRect=Q,f.plugin=Pt,f.rect2ImageBounds=q,f.resizeImage=$e,f.version=Ot,Object.defineProperty(f,Symbol.toStringTag,{value:"Module"})});
