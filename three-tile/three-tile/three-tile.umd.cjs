(function(g,a){typeof exports=="object"&&typeof module<"u"?a(exports,require("three")):typeof define=="function"&&define.amd?define(["exports","three"],a):(g=typeof globalThis<"u"?globalThis:g||self,a(g.tt={},g.THREE))})(this,function(g,a){"use strict";const fe={name:"three-tile",private:!1,version:"0.6.1",type:"module",files:["dist","images","docs"],main:"dist/three-tile.umd.cjs",module:"dist/three-tile.js",types:"./dist/three-tile.es.d.ts",exports:{".":{import:"./dist/three-tile.js",require:"./dist/three-tile.umd.cjs",types:"./dist/three-tile.es.d.ts"}},description:"A lightweight tile map using threejs",license:"GPL-3.0",author:{name:"GuoJiangfeng",email:"hz_gjf@163.com"},keywords:["three","gis","tile","map","3D","cesium"],scripts:{dev:"vite --config vite.config.dev.ts",lib:"tsc && vite build  --config vite.config.lib.ts",demo:"tsc && vite build  --config vite.config.demo.ts",docs:"typedoc src --out ./docs",test:"vitest"},devDependencies:{"@types/node":"^20.2.3","@types/offscreencanvas":"^2019.7.0","@types/three":"^0.152.1","@typescript-eslint/eslint-plugin":"^7.5.0","@typescript-eslint/parser":"^7.5.0",esbuild:"^0.20.2",jsdom:"^24.1.0",typedoc:"^0.25.13",typescript:"^5.4.5",vite:"^5.2.8","vite-plugin-dts":"^3.8.1",vitest:"^1.6.0"},dependencies:{three:"^0.165.0"},publishConfig:{registry:"https://registry.npmjs.org/"}};function F(n,e,o,t,s){const r=new G(n,e,o);return r.position.copy(t),r.scale.copy(s),r}function Je(n,e=!1){if(n.isTile){const o=n.coord.z+1,t=n.coord.x*2,s=0,r=1/4;if(n.coord.z===0&&e){const c=n.coord.y,l=new a.Vector3(.5,1,1);n.add(F(t,c,o,new a.Vector3(-r,0,s),l)),n.add(F(t+1,c,o,new a.Vector3(r,0,s),l))}else{const c=n.coord.y*2,l=new a.Vector3(.5,.5,1);n.add(F(t,c+1,o,new a.Vector3(-r,-r,s),l)),n.add(F(t+1,c+1,o,new a.Vector3(r,-r,s),l)),n.add(F(t,c,o,new a.Vector3(-r,r,s),l)),n.add(F(t+1,c,o,new a.Vector3(r,r,s),l))}n.traverse(c=>{c.updateMatrix(),c.updateMatrixWorld(),c.receiveShadow=n.receiveShadow,c.castShadow=n.castShadow})}return n.children}const et=new a.Vector3;function tt(n,e,o){const t=n.position.clone().setZ(o).applyMatrix4(n.matrixWorld);return e.distanceTo(t)}function ot(n){const e=new a.Vector3(-.5,-.5,0).applyMatrix4(n.matrixWorld),o=new a.Vector3(.5,.5,0).applyMatrix4(n.matrixWorld);return e.sub(o).length()}function ge(n,e){const o=e.getWorldPosition(et),t=tt(n,o,n.avgZ),s=ot(n),r=t/s;return Math.log10(r)*5+.5}var te=(n=>(n[n.none=0]="none",n[n.create=1]="create",n[n.remove=2]="remove",n))(te||{});function it(n,e,o,t,s){if(n.coord.z>o&&n.index===0&&n.parent?.isTile){const c=ge(n.parent,e);if(n.coord.z>t||c>s*1.02)return 2}if(n.coord.z<t&&n.isLeafInFrustum){const c=ge(n,e);if(n.userData.dist=c,n.coord.z<o||c<s/1.02)return 1}return 0}const oe=new a.PlaneGeometry,ie=new a.MeshBasicMaterial({color:16711680});class G extends a.Mesh{coord;isTile=!0;parent=null;children=[];maxZ=0;minZ=0;avgZ=0;get index(){return this.parent?this.parent.children.indexOf(this):-1}_abortController=new AbortController;get abortSignal(){return this._abortController.signal}_loadState="empty";get loadState(){return this._loadState}_toLoad=!1;get _needsLoad(){return this.inFrustum&&this._toLoad&&this.loadState==="empty"}_inFrustum=!1;get inFrustum(){return this._inFrustum}set inFrustum(e){this._inFrustum!=e&&(this._inFrustum=e,e?this._toLoad=this.isLeaf:this.dispose(!0))}get isLeafInFrustum(){return this.inFrustum&&this.isLeaf}_isTemp=!1;set isTemp(e){if(this._isTemp=e,this.material.forEach(o=>{"wireframe"in o&&(o.wireframe=e||o.userData.wireframe)}),!e){const o=this._getLoadedParent();o&&o.loadState}}get isLeaf(){return this.children.length===0}constructor(e=0,o=0,t=0){super(oe,[ie]),this.coord={x:e,y:o,z:t},this.name=`Tile ${t}-${e}-${o}`,this.matrixAutoUpdate=!1,this.matrixWorldAutoUpdate=!1}traverse(e){e(this),this.children.forEach(o=>{o.traverse(e)})}raycast(e,o){this.loadState==="loaded"&&super.raycast(e,o)}_lod(e,o,t,s,r){let c=[];const l=it(this,e,o,t,s);if(l===te.create)c=Je(this,r),this._toLoad=!1;else if(l===te.remove){const u=this.parent;u?.isTile&&(u._toLoad=!0)}return c}_load(e){return this._needsLoad?(this._abortController=new AbortController,this._loadState="loading",new Promise((o,t)=>{e.load(this,()=>o(this._onLoad()),s=>o(this._onError(s)))})):Promise.resolve()}_onError(e){this._toLoad=!1,e.name==="AbortError"?console.assert(this._loadState==="empty"):(this._loadState="loaded",console.error(e.message||e.type||e))}_getLoadedParent(){const e=this.parent;return!e||!e.isTile?null:e.loadState==="loaded"&&!e._isTemp?e:e._getLoadedParent()}_checkVisible(){const e=[];this.traverse(t=>e.push(t));const o=!e.filter(t=>t.isLeafInFrustum).some(t=>t.loadState!="loaded");return o&&e.forEach(t=>{t.isLeaf?t.isTemp=!1:t.dispose(!1)}),o}_onLoad(){this._loadState="loaded",this.material.forEach(e=>{"wireframe"in e&&(e.userData.wireframe=e.wireframe)}),this._updateHeight(),!this.isLeaf&&this._toLoad&&(this.children.forEach(e=>e.dispose(!0)),this.clear()),this.isTemp=this._getLoadedParent()!=null,this._toLoad=!1,this._getLoadedParent()?._checkVisible()}_updateHeight(){this.geometry.computeBoundingBox(),this.maxZ=this.geometry.boundingBox?.max.z||0,this.minZ=this.geometry.boundingBox?.min.z||0,this.avgZ=(this.maxZ+this.minZ)/2}abortLoad(){this._abortController.abort()}dispose(e){return this.loadState!="empty"&&this._dispose(),e&&(this.children.forEach(o=>{o.dispose(e),o.clear()}),this.clear()),this}_dispose(){this.abortLoad(),this._loadState="empty",this.isTemp=!0,this._toLoad=!1,this.material[0]!=ie&&(this.material.forEach(e=>e.dispose()),this.material=[ie]),this.geometry!=oe&&(this.geometry.dispose(),this.geometry.groups=[],this.geometry=oe),this.dispatchEvent({type:"dispose"})}}const st=new a.Matrix4,ye=new a.Frustum;class be extends G{_treeReadyCount=0;_autoLoad=!0;_loader;_minLevel=0;get minLevel(){return this._minLevel}set minLevel(e){this._minLevel=e}_maxLevel=19;get maxLevel(){return this._maxLevel}set maxLevel(e){this._maxLevel=e}_LODThreshold=1;get LODThreshold(){return this._LODThreshold}set LODThreshold(e){this._LODThreshold=e}isWGS=!1;get loader(){return this._loader}set loader(e){this._loader=e}get autoLoad(){return this._autoLoad}set autoLoad(e){this._autoLoad=e}_vierwerBufferSize=.6;_tileBox=new a.Box3(new a.Vector3(-this.viewerbufferSize,-this.viewerbufferSize,0),new a.Vector3(this.viewerbufferSize,this.viewerbufferSize,10));get viewerbufferSize(){return this._vierwerBufferSize}set viewerbufferSize(e){this._vierwerBufferSize=Math.min(Math.max(e,.5),2.5),this._tileBox=new a.Box3(new a.Vector3(-this.viewerbufferSize,-this.viewerbufferSize,0),new a.Vector3(this.viewerbufferSize,this.viewerbufferSize,9))}constructor(e,o=0,t=0,s=0){super(o,t,s),this._loader=e,this.matrixAutoUpdate=!0,this.matrixWorldAutoUpdate=!0}update(e){return this._updateTileTree(e)?this._treeReadyCount=0:this._treeReadyCount=Math.min(this._treeReadyCount+1,100),this.autoLoad&&this._treeReadyCount>10&&this._updateTileData(),this}reload(){return this.dispose(!0),this}_updateTileTree(e){let o=!1;return ye.setFromProjectionMatrix(st.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse)),this.traverse(t=>{if(t.isTile){t.geometry.computeBoundingBox(),t.geometry.computeBoundingSphere(),t.inFrustum=ye.intersectsBox(this._tileBox.clone().applyMatrix4(t.matrixWorld));const s=t._lod(e,this.minLevel,this.maxLevel,this.LODThreshold,this.isWGS);s.forEach(r=>{this.dispatchEvent({type:"tile-created",tile:r})}),s.length>0&&(o=!0)}}),o}_updateTileData(){return this.traverse(e=>{e.isTile&&e._load(this.loader).then(()=>{e.loadState==="loaded"&&(this._updateVisibleHight(),this.dispatchEvent({type:"tile-loaded",tile:e}))})}),this}_updateVisibleHight(){let e=0,o=0;this.maxZ=0,this.minZ=9e3,this.traverse(t=>{t.isTile&&t.isLeafInFrustum&&t.loadState==="loaded"&&(this.maxZ=Math.max(this.maxZ,t.maxZ),this.minZ=Math.min(this.minZ,t.minZ),e+=t.avgZ,o++)}),o>0&&(this.avgZ=e/o)}}class we extends a.MeshLambertMaterial{constructor(e={transparent:!0,side:a.FrontSide}){super(e)}}class nt extends a.PlaneGeometry{build(e,o){this.dispose(),this.copy(new a.PlaneGeometry(1,1,o-1,o-1));const t=this.getAttribute("position");for(let s=0;s<t.count;s++)t.setZ(s,e[s])}setData(e,o){if(e.length!=o*o)throw"DEM array size error!";return this.build(e,o),this.computeBoundingBox(),this.computeBoundingSphere(),this.computeVertexNormals(),this}}class Te extends a.PlaneGeometry{_min=1/0;build(e,o){this.dispose();const t=1,s=1,r=o-1,c=o-1,l=t/2,u=s/2;let h=Math.floor(r),m=Math.floor(c);const S=t/h,x=s/m;h+=2,m+=2;const w=h+1,_=m+1,M=[],D=[],I=[],z=[];let A=0;this._min=Math.min(...Array.from(e));for(let v=0;v<_;v++)for(let b=0;b<w;b++){let O=(b-1)*S-l,y=(v-1)*x-u,j=(b-1)/(h-2),C=1-(v-1)/(m-2);O=a.MathUtils.clamp(O,-.5,.5),y=a.MathUtils.clamp(y,-.5,.5),j=a.MathUtils.clamp(j,0,1),C=a.MathUtils.clamp(C,0,1);let Z=0;v===0||v===_-1||b===0||b===w-1?Z=this._min-.1:(Z=e[A],A++),D.push(O,-y,Z),I.push(0,0,1),z.push(j,C)}for(let v=0;v<m;v++)for(let b=0;b<h;b++){const O=b+w*v,y=b+w*(v+1),j=b+1+w*(v+1),C=b+1+w*v;M.push(O,y,C),M.push(y,j,C)}return this.setIndex(M),this.setAttribute("position",new a.Float32BufferAttribute(D,3)),this.setAttribute("normal",new a.Float32BufferAttribute(I,3)),this.setAttribute("uv",new a.Float32BufferAttribute(z,2)),this}setData(e,o){if(e.length!=o*o)throw"DEM array size error!";return this.build(e,o),this.computeBoundingBox(),this.computeBoundingSphere(),this.computeVertexNormals(),this}computeVertexNormals(){super.computeVertexNormals();const e=this.index,o=this.getAttribute("position"),t=this.getAttribute("normal"),s=new a.Vector3,r=new a.Vector3,c=new a.Vector3,l=new a.Vector3(0,0,1);function u(h){return t.setXYZ(h,l.x,l.y,l.z)}if(e)for(let h=0,m=e.count;h<m;h+=3){const S=e.getX(h+0),x=e.getX(h+1),w=e.getX(h+2);s.fromBufferAttribute(o,S),r.fromBufferAttribute(o,x),c.fromBufferAttribute(o,w),(s.z<this._min||r.z<this._min||c.z<this._min)&&(u(S),u(x),u(w))}t.needsUpdate=!0}}class K{static enabled=!0;static size=500;static files=new Map;static add(e,o){if(!this.enabled||this.files.has(e))return;this.files.set(e,o);const t=Array.from(this.files.keys()),s=this.files.size-this.size;for(let r=0;r<s;r++)this.remove(t[r]);console.assert(this.files.size<=this.size)}static get(e){if(this.enabled)return this.files.get(e)}static remove(e){this.files.delete(e)}static clear(){this.files.clear()}}class rt extends Error{response;constructor(e,o){super(e),this.response=o}}class xe extends a.Loader{mimeType;responseType;constructor(e){super(e)}load(e,o,t,s,r){this.path!==void 0&&(e=this.path+e),e=this.manager.resolveURL(e);const c=K.get(e);if(c)return this.manager.itemStart(e),setTimeout(()=>{o&&o(c),this.manager.itemEnd(e)}),c;if(r?.aborted){console.log("aborted befor load");return}const l=new Request(e,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin",signal:r}),u=this.mimeType,h=this.responseType;fetch(l).then(m=>{if(m.status===200||m.status===0)return m.status===0&&console.warn("THREE.FileLoader: HTTP Status 0 received."),m;throw new rt(`fetch for "${m.url}" responded with ${m.status}: ${m.statusText}`,m)}).then(m=>{switch(h){case"arraybuffer":return m.arrayBuffer();case"blob":return m.blob();case"document":return m.text().then(S=>new DOMParser().parseFromString(S,u));case"json":return m.json();default:if(u===void 0)return m.text();{const x=/charset="?([^;"\s]*)"?/i.exec(u),w=x&&x[1]?x[1].toLowerCase():void 0,_=new TextDecoder(w);return m.arrayBuffer().then(M=>_.decode(M))}}}).then(m=>{K.add(e,m),o&&o(m)}).catch(m=>{s&&s(m),m.name!="AbortError"&&this.manager.itemError(e)}).finally(()=>{this.manager.itemEnd(e)}),this.manager.itemStart(e)}setResponseType(e){return this.responseType=e,this}setMimeType(e){return this.mimeType=e,this}}const T={manager:new a.LoadingManager,demLoaderMap:new Map,imgLoaderMap:new Map,registerMaterialLoader(n){T.imgLoaderMap.set(n.dataType,n),console.log(`* Register imageLoader: ${n.dataType}`)},registerGeometryLoader(n){T.demLoaderMap.set(n.dataType,n),console.log(`* Register terrainLoader: ${n.dataType}`)},getMaterialLoader(n){const e=T.imgLoaderMap.get(n.dataType);if(e)return e;throw`Source dataType "${n.dataType}" is not support!`},getGeometryLoader(n){const e=T.demLoaderMap.get(n.dataType);if(e)return e;throw`Source dataType "${n.dataType}" is not support!`}},at="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";class se extends a.Loader{loader=new xe(T.manager);constructor(e){super(e),this.loader.setResponseType("blob")}load(e,o,t,s,r){const c=new Image,l=m=>{h(),o&&o(c)},u=m=>{h(),s&&s(m),c.src=at},h=()=>{c.removeEventListener("load",l,!1),c.removeEventListener("error",u,!1)};return c.addEventListener("load",l,!1),c.addEventListener("error",u,!1),this.crossOrigin,this.requestHeader,this.loader.load(e,m=>{o&&(c.src=URL.createObjectURL(m))},t,s,r),c}}function ne(n,e){n.translate(new a.Vector2(.5,.5));const o=Math.floor(n.min.x*e),t=Math.floor(n.min.y*e),s=Math.floor((n.max.x-n.min.x)*e),r=Math.floor((n.max.y-n.min.y)*e);return{sx:o,sy:t,sw:s,sh:r}}function ct(n,e){if(n.width<=e)return n;const o=document.createElement("canvas"),t=o.getContext("2d");o.width=e,o.height=e;const s=e-2;t.drawImage(n,0,0,n.width,n.height,1,1,s,s);const r=t.getImageData(1,1,s,s);return t.putImageData(r,0,0),o}function re(n,e){if(e.coord.z<=n.maxLevel)return{url:n.getTileUrl(e.coord.x,e.coord.y,e.coord.z),rect:new a.Box2(new a.Vector2(-.5,-.5),new a.Vector2(.5,.5))};function o(r,c){const l=new a.Vector3,u=new a.Vector2(1,1);for(;r.coord.z>c&&(l.applyMatrix4(r.matrix),u.multiplyScalar(.5),r.parent instanceof G);)r=r.parent;l.setY(-l.y);const h=new a.Box2().setFromCenterAndSize(new a.Vector2(l.x,l.y),u);return{tile:r,rect:h}}const t=o(e,n.maxLevel);return{url:n.getTileUrl(t.tile.coord.x,t.tile.coord.y,t.tile.coord.z),rect:t.rect}}class Le extends a.Loader{get cacheSize(){return K.size}set cacheSize(e){K.size=e}_imgSource=[];get imgSource(){return this._imgSource}set imgSource(e){this._imgSource=e}_demSource;get demSource(){return this._demSource}set demSource(e){this._demSource=e}constructor(){super(T.manager)}load(e,o,t){if(this.imgSource.length===0)throw new Error("imgSource can not be empty");const s=()=>{if(r&&c){for(let h=0;h<u.length;h++)l.addGroup(0,1/0,h);o()}};let r=!1,c=!1;const l=this.loadGeometry(e,()=>{r=!0,s()},t),u=this.loadMaterial(e,()=>{c=!0,s()},t);return e.geometry=l,e.material=u,{geometry:l,material:u}}loadGeometry(e,o,t){let s;return this.demSource?s=T.getGeometryLoader(this.demSource).load(this.demSource,e,o,t):(s=new a.PlaneGeometry,setTimeout(o)),s}loadMaterial(e,o,t){const s=this.imgSource.map(r=>{const l=T.getMaterialLoader(r).load(r,e,()=>{l.userData.loaded=!0,s.every(u=>u.userData.loaded)&&o()},t);return l});return s}}const lt=new a.Texture(new Image(1,1));class ve{loader=new se(T.manager);load(e,o,t,s){const{url:r,rect:c}=re(e,o);if(!r)return setTimeout(t),lt;const l=new a.Texture(new Image);return l.colorSpace=a.SRGBColorSpace,this.loader.load(r,u=>{o.coord.z>e.maxLevel?l.image=dt(u,c):l.image=u,l.needsUpdate=!0,t()},void 0,s,o.abortSignal),l}}function dt(n,e){const o=n.width,t=new OffscreenCanvas(o,o),s=t.getContext("2d"),{sx:r,sy:c,sw:l,sh:u}=ne(e,n.width);return s.drawImage(n,r,c,l,u,0,0,o,o),t}class ut{dataType="image";load(e,o,t,s){const r=h=>{const m=h.target;m.map?.image instanceof ImageBitmap&&m.map.image.close(),m.map?.dispose(),m.removeEventListener("dispose",r)},c=this.createMaterial();c.opacity=e.opacity,c.addEventListener("dispose",r);const u=new ve().load(e,o,()=>{c.map=u,u.needsUpdate=!0,t()},h=>{s(h)});return c}createMaterial(){return new we}}T.registerMaterialLoader(new ut);const ht=new a.BufferGeometry;class mt extends a.Loader{dataType="terrain-rgb";imageLoader=new se(T.manager);load(e,o,t,s){if(o.coord.z<8)return setTimeout(t),new a.PlaneGeometry;const{url:r,rect:c}=re(e,o);return r?this._load(o,r,c,t,s):(setTimeout(t),ht)}_load(e,o,t,s,r){let c=e.coord.z*3;c=Math.min(Math.max(c,2),48);const l=this.createGeometry();return this.imageLoader.load(o,u=>{const{data:h,size:m}=gt(u,c,t);l.setData(ft(h),m),s()},void 0,r,e.abortSignal),l}createGeometry(){return new Te}}function pt(n,e){const o=n[e*4],t=n[e*4+1],s=n[e*4+2];return(((o<<16)+(t<<8)+s)*.1-1e4)/1e3}function ft(n){const e=Math.floor(n.length/4),o=new Float32Array(e);for(let t=0;t<o.length;t++)o[t]=pt(n,t);return o}function gt(n,e,o){const s=new OffscreenCanvas(e,e).getContext("2d");s.imageSmoothingEnabled=!1;const r=ne(o,n.width);return e>r.sw&&(e=r.sw),s.drawImage(n,r.sx,r.sy,r.sw,r.sh,0,0,e,e),{data:s.getImageData(0,0,e,e).data,size:e}}T.registerGeometryLoader(new mt);class L{dataType="image";attribution="ThreeTile";minLevel=0;maxLevel=19;projectionID="3857";url="";subdomains=[];s="";opacity=1;bounds=[-180,-85.05112877980659,180,85.05112877980659];constructor(e){Object.assign(this,e)}getTileUrl(e,o,t){const s=this.subdomains.length;if(s>0){const r=Math.floor(Math.random()*s);this.s=this.subdomains[r]}return this.getUrl(e,o,t)}getUrl(e,o,t){const s=Object.assign({},this,{x:e,y:o,z:t});return yt(this.url,s)}static create(e){return new L(e)}}function yt(n,e){const o=/\{ *([\w_ -]+) *\}/g;return n.replace(o,(t,s)=>{let r=e[s];if(r===void 0)throw new Error(`source url template error, No value provided for variable: ${t}`);return typeof r=="function"&&(r=r(e)),r})}class ae extends L{_source;_projection;get projection(){return this._projection}set projection(e){this._projection=e,this._bounds=this.projection.getPorjBounds(this._source.bounds)}_bounds;_getTileBounds(e,o,t,s=1){const r=this.projection.getTileXYZproj(e,o,t),c=this.projection.getTileXYZproj(e+s,o+s,t);return{minX:Math.min(r.x,c.x),minY:Math.min(r.y,c.y),maxX:Math.max(r.x,c.x),maxY:Math.max(r.y,c.y)}}constructor(e,o){super(),Object.assign(this,e),this._source=e,this.projection=o}getUrl(e,o,t){const s=Math.pow(2,t);let r=e+Math.round(s/360*this.projection.lon0);r>=s?r-=s:r<0&&(r+=s);const c=.9,l=this._bounds,u=this._getTileBounds(r,o,t,c);if(!(u.maxX<l.minX||u.minX>l.maxX||u.maxY<l.minY||u.minY>l.maxY))return this._source.getTileUrl(r,o,t)}}class Se{_lon0=0;get lon0(){return this._lon0}constructor(e=0){this._lon0=e}getTileXWithCenterLon(e,o){const t=Math.pow(2,o);let s=e+Math.round(t/360*this._lon0);return s>=t?s-=t:s<0&&(s+=t),s}getTileXYZproj(e,o,t){const s=this.mapWidth,r=this.mapHeight/2,c=e/Math.pow(2,t)*s-s/2,l=r-o/Math.pow(2,t)*r*2;return{x:c,y:l}}getPorjBounds(e){const o=this.project(e[0]+this.lon0,e[1]),t=this.project(e[2]+this.lon0,e[3]);return{minX:Math.min(o.x,t.x),minY:Math.min(o.y,t.y),maxX:Math.max(o.x,t.x),maxY:Math.max(o.y,t.y)}}}const Y=6378;class Ee extends Se{ID="3857";isWGS=!1;mapWidth=2*Math.PI*Y;mapHeight=this.mapWidth;mapDepth=1;project(e,o){const t=(e-this.lon0)*(Math.PI/180),s=o*(Math.PI/180),r=Y*t,c=Y*Math.log(Math.tan(Math.PI/4+s/2));return{x:r,y:c}}unProject(e,o){const t=e/Y*(180/Math.PI)+this.lon0;return{lat:(2*Math.atan(Math.exp(o/Y))-Math.PI/2)*(180/Math.PI),lon:t}}}class bt extends Se{ID="4326";isWGS=!0;mapWidth=36e3;mapHeight=18e3;mapDepth=1;project(e,o){return{x:(e-this.lon0)*100,y:o*100}}unProject(e,o){return{lon:e/100+this.lon0,lat:o/100}}}const Me={createFromID:(n="3857",e)=>{let o;switch(n){case"3857":o=new Ee(e);break;case"4326":o=new bt(e);break;default:throw new Error(`Projection ID: ${n} is not supported.`)}return o}};function _e(n,e){const o=e.intersectObjects([n.rootTile]);for(const t of o)if(t.object instanceof G){const s=n.worldToLocal(t.point),r=n.pos2geo(s);return Object.assign(t,{location:r})}}function Pe(n,e){const o=new a.Vector3(0,-1,0),t=new a.Vector3(e.x,10,e.z),s=new a.Raycaster(t,o);return _e(n,s)}function wt(n,e,o){const t=new a.Raycaster;return t.setFromCamera(o,n),_e(e,t)}function Tt(n){const e=n.loader.manager;return e.onStart=(o,t,s)=>{n.dispatchEvent({type:"loading-start",itemsLoaded:t,itemsTotal:s})},e.onError=o=>{n.dispatchEvent({type:"loading-error",url:o})},e.onLoad=()=>{n.dispatchEvent({type:"loading-complete"})},e.onProgress=(o,t,s)=>{n.dispatchEvent({type:"loading-progress",url:o,itemsLoaded:t,itemsTotal:s})},n.rootTile.addEventListener("tile-created",o=>{n.dispatchEvent({type:"tile-created",tile:o.tile})}),n.rootTile.addEventListener("tile-loaded",o=>{n.dispatchEvent({type:"tile-loaded",tile:o.tile})}),n.rootTile.addEventListener("loaded",()=>{n.dispatchEvent({type:"loaded"})}),n}function xt(n){let e=0,o=0,t=0,s=0;return n.rootTile.traverse(r=>{r.isTile&&(e++,r.isLeafInFrustum&&o++,r.isLeaf&&s++,t=Math.max(t,r.coord.z))}),{total:e,visible:o,leaf:s,maxLevle:t}}function Lt(n){const e=[];let o=n.imgSource;if(Array.isArray(o)||(o=[o]),o.forEach(t=>{const s=t.attribution;s&&e.push(s)}),n.demSource){const t=n.demSource.attribution;t&&e.push(t)}return Array.from(new Set(e))}class ce extends a.Mesh{_clock=new a.Clock;isLOD=!0;autoUpdate=!0;rootTile;loader;get minLevel(){return this.rootTile.minLevel}set minLevel(e){this.rootTile.minLevel=e}get maxLevel(){return this.rootTile.maxLevel}set maxLevel(e){this.rootTile.maxLevel=e}get autoLoad(){return this.rootTile.autoLoad}set autoLoad(e){this.rootTile.autoLoad=e}_autoPosition=!1;get autoPosition(){return this._autoPosition}set autoPosition(e){this._autoPosition=e}get loadCacheSize(){return this.loader.cacheSize}set loadCacheSize(e){this.loader.cacheSize=e}get viewerBufferSize(){return this.rootTile.viewerbufferSize*2}set viewerBufferSize(e){this.rootTile.viewerbufferSize=e/2}get maxZInView(){return this.rootTile.maxZ}get minZInView(){return this.rootTile.minZ}get avgZInView(){return this.rootTile.avgZ}get lon0(){return this.projection.lon0}set lon0(e){this.projection.lon0!==e&&(e!=0&&this.rootTile.minLevel<1&&console.warn(`Map centralMeridian is ${this.lon0}, minLevel must > 0`),this.projection=Me.createFromID(this.projection.ID,e),this.reload())}_projection=new Ee(0);get projection(){return this._projection}set projection(e){this._projection=e,this.rootTile.scale.set(e.mapWidth,e.mapHeight,e.mapDepth),this.rootTile.isWGS=e.isWGS,this.imgSource.forEach(o=>o.projection=this.projection),this.demSource&&(this.demSource.projection=this.projection),e.ID!=this.projection.ID&&e.lon0!=this.lon0&&(this.reload(),console.log("Map Projection Changed:",e.ID),this.dispatchEvent({type:"projection-changed",projection:e}))}_imgSource=[];get imgSource(){return this._imgSource}set imgSource(e){const o=Array.isArray(e)?e:[e];if(o.length===0)throw new Error("imgSource can not be empty");this.projection=Me.createFromID(o[0].projectionID,this.projection.lon0);const t=o.map(s=>s instanceof ae?s:new ae(s,this.projection));this._imgSource=t,this.loader.imgSource=t,this.dispatchEvent({type:"source-changed",source:e})}_demSource;get demSource(){return this._demSource}set demSource(e){e&&(this._demSource=new ae(e,this.projection),this.loader.demSource=this._demSource),this.dispatchEvent({type:"source-changed",source:e})}get LODThreshold(){return this.rootTile.LODThreshold}set LODThreshold(e){this.rootTile.LODThreshold=e}static create(e){return new ce(e)}constructor(e){super(),this.up.set(0,0,1),this.loader=e.loader??new Le,this.rootTile=e.rootTile??new be(this.loader),this.minLevel=e.minLevel??0,this.maxLevel=e.maxLevel??19,this.imgSource=e.imgSource,this.demSource=e.demSource,this.lon0=e.lon0??0,Tt(this),this.add(this.rootTile),this.rootTile.updateMatrix(),this.rootTile.updateMatrixWorld()}update(e){if(this.rootTile.receiveShadow=this.receiveShadow,this.rootTile.castShadow=this.castShadow,this.autoPosition){const o=this.localToWorld(this.up.clone().multiplyScalar(this.avgZInView)),t=this.position.clone().add(o).multiplyScalar(.01);this.position.sub(t)}this.rootTile.update(e),this.dispatchEvent({type:"update",delta:this._clock.getDelta()})}reload(){this.rootTile.dispose(!0)}dispose(){this.removeFromParent(),this.reload()}geo2pos(e){const o=this.projection.project(e.x,e.y);return new a.Vector3(o.x,o.y,e.z)}pos2geo(e){const o=this.projection.unProject(e.x,e.y);return new a.Vector3(o.lon,o.lat,e.z)}getLocalInfoFromGeo(e){const o=this.geo2pos(e);return Pe(this,o)}getLocalInfoFromWorld(e){return Pe(this,e)}getLocalInfoFromScreen(e,o){return wt(e,this,o)}get attributions(){return Lt(this)}get tileCount(){return xt(this)}}class vt{dataType="debug";load(e,o,t,s){const r=u=>{const h=u.target;h.map?.image instanceof ImageBitmap&&h.map.image.close(),h.map?.dispose(),h.removeEventListener("dispose",r)},c=new a.CanvasTexture(this.drawTile(o));c.needsUpdate=!0;const l=new a.MeshBasicMaterial({transparent:!0,map:c,opacity:e.opacity});return l.addEventListener("dispose",r),setTimeout(t),l}drawTile(e){const t=new OffscreenCanvas(256,256),s=t.getContext("2d");return s.scale(1,-1),s.translate(0,-256),s&&(s.strokeStyle="#ccc",s.lineWidth=4,s.strokeRect(5,5,246,246),s.fillStyle="white",s.shadowColor="black",s.shadowBlur=5,s.shadowOffsetX=1,s.shadowOffsetY=1,s.font="bold 20px arial",s.textAlign="center",s.fillText(`Tile Test - level: ${e.coord.z}`,256/2,50),s.fillText(`[${e.coord.x}, ${e.coord.y}]`,256/2,80)),t.transferToImageBitmap()}}T.registerMaterialLoader(new vt);class St{dataType="logo";load(e,o,t,s){if(o.coord.z<4)return setTimeout(t),new a.MeshBasicMaterial;const r=new a.Texture(this.drawLogo(e.attribution));r.needsUpdate=!0;const c=new a.MeshBasicMaterial({transparent:!0,map:r,opacity:e.opacity}),l=u=>{const h=u.target;h.map?.image instanceof ImageBitmap&&h.map.image.close(),h.map?.dispose(),h.removeEventListener("dispose",l)};return c.addEventListener("dispose",l),setTimeout(t),c}drawLogo(e){const t=new OffscreenCanvas(256,256),s=t.getContext("2d");return s.scale(1,-1),s.translate(0,-256),s&&(s.fillStyle="white",s.shadowColor="black",s.shadowBlur=5,s.shadowOffsetX=1,s.shadowOffsetY=1,s.font="bold 14px arial",s.textAlign="center",s.translate(256/2,256/2),s.rotate(30*Math.PI/180),s.fillText(`${e}`,0,0)),t.transferToImageBitmap()}}T.registerMaterialLoader(new St);class Et{dataType="normal";load(e,o,t,s){const r=new a.MeshNormalMaterial({transparent:!0,opacity:e.opacity,flatShading:!0});return setTimeout(t),r}}T.registerMaterialLoader(new Et);class Mt{dataType="wireframe";load(e,o,t,s){const r=new a.Color(`hsl(${o.coord.z*14}, 100%, 50%)`),c=new a.MeshBasicMaterial({transparent:!0,wireframe:!0,color:r,opacity:e.opacity});return setTimeout(t),c}}T.registerMaterialLoader(new Mt);const je={type:"change"},le={type:"start"},Ae={type:"end"},q=new a.Ray,Oe=new a.Plane,_t=Math.cos(70*a.MathUtils.DEG2RAD);class Pt extends a.EventDispatcher{constructor(e,o){super(),this.object=e,this.domElement=o,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new a.Vector3,this.cursor=new a.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:a.MOUSE.ROTATE,MIDDLE:a.MOUSE.DOLLY,RIGHT:a.MOUSE.PAN},this.touches={ONE:a.TOUCH.ROTATE,TWO:a.TOUCH.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return l.phi},this.getAzimuthalAngle=function(){return l.theta},this.getDistance=function(){return this.object.position.distanceTo(this.target)},this.listenToKeyEvents=function(i){i.addEventListener("keydown",pe),this._domElementKeyEvents=i},this.stopListenToKeyEvents=function(){this._domElementKeyEvents.removeEventListener("keydown",pe),this._domElementKeyEvents=null},this.saveState=function(){t.target0.copy(t.target),t.position0.copy(t.object.position),t.zoom0=t.object.zoom},this.reset=function(){t.target.copy(t.target0),t.object.position.copy(t.position0),t.object.zoom=t.zoom0,t.object.updateProjectionMatrix(),t.dispatchEvent(je),t.update(),r=s.NONE},this.update=function(){const i=new a.Vector3,d=new a.Quaternion().setFromUnitVectors(e.up,new a.Vector3(0,1,0)),p=d.clone().invert(),f=new a.Vector3,E=new a.Quaternion,B=new a.Vector3,P=2*Math.PI;return function(po=null){const qe=t.object.position;i.copy(qe).sub(t.target),i.applyQuaternion(d),l.setFromVector3(i),t.autoRotate&&r===s.NONE&&H(Z(po)),t.enableDamping?(l.theta+=u.theta*t.dampingFactor,l.phi+=u.phi*t.dampingFactor):(l.theta+=u.theta,l.phi+=u.phi);let k=t.minAzimuthAngle,R=t.maxAzimuthAngle;isFinite(k)&&isFinite(R)&&(k<-Math.PI?k+=P:k>Math.PI&&(k-=P),R<-Math.PI?R+=P:R>Math.PI&&(R-=P),k<=R?l.theta=Math.max(k,Math.min(R,l.theta)):l.theta=l.theta>(k+R)/2?Math.max(k,l.theta):Math.min(R,l.theta)),l.phi=Math.max(t.minPolarAngle,Math.min(t.maxPolarAngle,l.phi)),l.makeSafe(),t.enableDamping===!0?t.target.addScaledVector(m,t.dampingFactor):t.target.add(m),t.target.sub(t.cursor),t.target.clampLength(t.minTargetRadius,t.maxTargetRadius),t.target.add(t.cursor);let X=!1;if(t.zoomToCursor&&O||t.object.isOrthographicCamera)l.radius=he(l.radius);else{const V=l.radius;l.radius=he(l.radius*h),X=V!=l.radius}if(i.setFromSpherical(l),i.applyQuaternion(p),qe.copy(t.target).add(i),t.object.lookAt(t.target),t.enableDamping===!0?(u.theta*=1-t.dampingFactor,u.phi*=1-t.dampingFactor,m.multiplyScalar(1-t.dampingFactor)):(u.set(0,0,0),m.set(0,0,0)),t.zoomToCursor&&O){let V=null;if(t.object.isPerspectiveCamera){const $=i.length();V=he($*h);const ee=$-V;t.object.position.addScaledVector(v,ee),t.object.updateMatrixWorld(),X=!!ee}else if(t.object.isOrthographicCamera){const $=new a.Vector3(b.x,b.y,0);$.unproject(t.object);const ee=t.object.zoom;t.object.zoom=Math.max(t.minZoom,Math.min(t.maxZoom,t.object.zoom/h)),t.object.updateProjectionMatrix(),X=ee!==t.object.zoom;const Qe=new a.Vector3(b.x,b.y,0);Qe.unproject(t.object),t.object.position.sub(Qe).add($),t.object.updateMatrixWorld(),V=i.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),t.zoomToCursor=!1;V!==null&&(this.screenSpacePanning?t.target.set(0,0,-1).transformDirection(t.object.matrix).multiplyScalar(V).add(t.object.position):(q.origin.copy(t.object.position),q.direction.set(0,0,-1).transformDirection(t.object.matrix),Math.abs(t.object.up.dot(q.direction))<_t?e.lookAt(t.target):(Oe.setFromNormalAndCoplanarPoint(t.object.up,t.target),q.intersectPlane(Oe,t.target))))}else if(t.object.isOrthographicCamera){const V=t.object.zoom;t.object.zoom=Math.max(t.minZoom,Math.min(t.maxZoom,t.object.zoom/h)),V!==t.object.zoom&&(t.object.updateProjectionMatrix(),X=!0)}return h=1,O=!1,X||f.distanceToSquared(t.object.position)>c||8*(1-E.dot(t.object.quaternion))>c||B.distanceToSquared(t.target)>c?(t.dispatchEvent(je),f.copy(t.object.position),E.copy(t.object.quaternion),B.copy(t.target),!0):!1}}(),this.dispose=function(){t.domElement.removeEventListener("contextmenu",$e),t.domElement.removeEventListener("pointerdown",Ye),t.domElement.removeEventListener("pointercancel",W),t.domElement.removeEventListener("wheel",Ze),t.domElement.removeEventListener("pointermove",me),t.domElement.removeEventListener("pointerup",W),t.domElement.getRootNode().removeEventListener("keydown",He,{capture:!0}),t._domElementKeyEvents!==null&&(t._domElementKeyEvents.removeEventListener("keydown",pe),t._domElementKeyEvents=null)};const t=this,s={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let r=s.NONE;const c=1e-6,l=new a.Spherical,u=new a.Spherical;let h=1;const m=new a.Vector3,S=new a.Vector2,x=new a.Vector2,w=new a.Vector2,_=new a.Vector2,M=new a.Vector2,D=new a.Vector2,I=new a.Vector2,z=new a.Vector2,A=new a.Vector2,v=new a.Vector3,b=new a.Vector2;let O=!1;const y=[],j={};let C=!1;function Z(i){return i!==null?2*Math.PI/60*t.autoRotateSpeed*i:2*Math.PI/60/60*t.autoRotateSpeed}function Q(i){const d=Math.abs(i*.01);return Math.pow(.95,t.zoomSpeed*d)}function H(i){u.theta-=i}function J(i){u.phi-=i}const De=function(){const i=new a.Vector3;return function(p,f){i.setFromMatrixColumn(f,0),i.multiplyScalar(-p),m.add(i)}}(),Ie=function(){const i=new a.Vector3;return function(p,f){t.screenSpacePanning===!0?i.setFromMatrixColumn(f,1):(i.setFromMatrixColumn(f,0),i.crossVectors(t.object.up,i)),i.multiplyScalar(p),m.add(i)}}(),U=function(){const i=new a.Vector3;return function(p,f){const E=t.domElement;if(t.object.isPerspectiveCamera){const B=t.object.position;i.copy(B).sub(t.target);let P=i.length();P*=Math.tan(t.object.fov/2*Math.PI/180),De(2*p*P/E.clientHeight,t.object.matrix),Ie(2*f*P/E.clientHeight,t.object.matrix)}else t.object.isOrthographicCamera?(De(p*(t.object.right-t.object.left)/t.object.zoom/E.clientWidth,t.object.matrix),Ie(f*(t.object.top-t.object.bottom)/t.object.zoom/E.clientHeight,t.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),t.enablePan=!1)}}();function de(i){t.object.isPerspectiveCamera||t.object.isOrthographicCamera?h/=i:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),t.enableZoom=!1)}function ze(i){t.object.isPerspectiveCamera||t.object.isOrthographicCamera?h*=i:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),t.enableZoom=!1)}function ue(i,d){if(!t.zoomToCursor)return;O=!0;const p=t.domElement.getBoundingClientRect(),f=i-p.left,E=d-p.top,B=p.width,P=p.height;b.x=f/B*2-1,b.y=-(E/P)*2+1,v.set(b.x,b.y,1).unproject(t.object).sub(t.object.position).normalize()}function he(i){return Math.max(t.minDistance,Math.min(t.maxDistance,i))}function ke(i){S.set(i.clientX,i.clientY)}function Kt(i){ue(i.clientX,i.clientX),I.set(i.clientX,i.clientY)}function Re(i){_.set(i.clientX,i.clientY)}function qt(i){x.set(i.clientX,i.clientY),w.subVectors(x,S).multiplyScalar(t.rotateSpeed);const d=t.domElement;H(2*Math.PI*w.x/d.clientHeight),J(2*Math.PI*w.y/d.clientHeight),S.copy(x),t.update()}function Qt(i){z.set(i.clientX,i.clientY),A.subVectors(z,I),A.y>0?de(Q(A.y)):A.y<0&&ze(Q(A.y)),I.copy(z),t.update()}function Jt(i){M.set(i.clientX,i.clientY),D.subVectors(M,_).multiplyScalar(t.panSpeed),U(D.x,D.y),_.copy(M),t.update()}function eo(i){ue(i.clientX,i.clientY),i.deltaY<0?ze(Q(i.deltaY)):i.deltaY>0&&de(Q(i.deltaY)),t.update()}function to(i){let d=!1;switch(i.code){case t.keys.UP:i.ctrlKey||i.metaKey||i.shiftKey?J(2*Math.PI*t.rotateSpeed/t.domElement.clientHeight):U(0,t.keyPanSpeed),d=!0;break;case t.keys.BOTTOM:i.ctrlKey||i.metaKey||i.shiftKey?J(-2*Math.PI*t.rotateSpeed/t.domElement.clientHeight):U(0,-t.keyPanSpeed),d=!0;break;case t.keys.LEFT:i.ctrlKey||i.metaKey||i.shiftKey?H(2*Math.PI*t.rotateSpeed/t.domElement.clientHeight):U(t.keyPanSpeed,0),d=!0;break;case t.keys.RIGHT:i.ctrlKey||i.metaKey||i.shiftKey?H(-2*Math.PI*t.rotateSpeed/t.domElement.clientHeight):U(-t.keyPanSpeed,0),d=!0;break}d&&(i.preventDefault(),t.update())}function Ve(i){if(y.length===1)S.set(i.pageX,i.pageY);else{const d=N(i),p=.5*(i.pageX+d.x),f=.5*(i.pageY+d.y);S.set(p,f)}}function Be(i){if(y.length===1)_.set(i.pageX,i.pageY);else{const d=N(i),p=.5*(i.pageX+d.x),f=.5*(i.pageY+d.y);_.set(p,f)}}function Fe(i){const d=N(i),p=i.pageX-d.x,f=i.pageY-d.y,E=Math.sqrt(p*p+f*f);I.set(0,E)}function oo(i){t.enableZoom&&Fe(i),t.enablePan&&Be(i)}function io(i){t.enableZoom&&Fe(i),t.enableRotate&&Ve(i)}function Ue(i){if(y.length==1)x.set(i.pageX,i.pageY);else{const p=N(i),f=.5*(i.pageX+p.x),E=.5*(i.pageY+p.y);x.set(f,E)}w.subVectors(x,S).multiplyScalar(t.rotateSpeed);const d=t.domElement;H(2*Math.PI*w.x/d.clientHeight),J(2*Math.PI*w.y/d.clientHeight),S.copy(x)}function Ne(i){if(y.length===1)M.set(i.pageX,i.pageY);else{const d=N(i),p=.5*(i.pageX+d.x),f=.5*(i.pageY+d.y);M.set(p,f)}D.subVectors(M,_).multiplyScalar(t.panSpeed),U(D.x,D.y),_.copy(M)}function Ge(i){const d=N(i),p=i.pageX-d.x,f=i.pageY-d.y,E=Math.sqrt(p*p+f*f);z.set(0,E),A.set(0,Math.pow(z.y/I.y,t.zoomSpeed)),de(A.y),I.copy(z);const B=(i.pageX+d.x)*.5,P=(i.pageY+d.y)*.5;ue(B,P)}function so(i){t.enableZoom&&Ge(i),t.enablePan&&Ne(i)}function no(i){t.enableZoom&&Ge(i),t.enableRotate&&Ue(i)}function Ye(i){t.enabled!==!1&&(y.length===0&&(t.domElement.setPointerCapture(i.pointerId),t.domElement.addEventListener("pointermove",me),t.domElement.addEventListener("pointerup",W)),!mo(i)&&(uo(i),i.pointerType==="touch"?Xe(i):ro(i)))}function me(i){t.enabled!==!1&&(i.pointerType==="touch"?lo(i):ao(i))}function W(i){switch(ho(i),y.length){case 0:t.domElement.releasePointerCapture(i.pointerId),t.domElement.removeEventListener("pointermove",me),t.domElement.removeEventListener("pointerup",W),t.dispatchEvent(Ae),r=s.NONE;break;case 1:const d=y[0],p=j[d];Xe({pointerId:d,pageX:p.x,pageY:p.y});break}}function ro(i){let d;switch(i.button){case 0:d=t.mouseButtons.LEFT;break;case 1:d=t.mouseButtons.MIDDLE;break;case 2:d=t.mouseButtons.RIGHT;break;default:d=-1}switch(d){case a.MOUSE.DOLLY:if(t.enableZoom===!1)return;Kt(i),r=s.DOLLY;break;case a.MOUSE.ROTATE:if(i.ctrlKey||i.metaKey||i.shiftKey){if(t.enablePan===!1)return;Re(i),r=s.PAN}else{if(t.enableRotate===!1)return;ke(i),r=s.ROTATE}break;case a.MOUSE.PAN:if(i.ctrlKey||i.metaKey||i.shiftKey){if(t.enableRotate===!1)return;ke(i),r=s.ROTATE}else{if(t.enablePan===!1)return;Re(i),r=s.PAN}break;default:r=s.NONE}r!==s.NONE&&t.dispatchEvent(le)}function ao(i){switch(r){case s.ROTATE:if(t.enableRotate===!1)return;qt(i);break;case s.DOLLY:if(t.enableZoom===!1)return;Qt(i);break;case s.PAN:if(t.enablePan===!1)return;Jt(i);break}}function Ze(i){t.enabled===!1||t.enableZoom===!1||r!==s.NONE||(i.preventDefault(),t.dispatchEvent(le),eo(co(i)),t.dispatchEvent(Ae))}function co(i){const d=i.deltaMode,p={clientX:i.clientX,clientY:i.clientY,deltaY:i.deltaY};switch(d){case 1:p.deltaY*=16;break;case 2:p.deltaY*=100;break}return i.ctrlKey&&!C&&(p.deltaY*=10),p}function He(i){i.key==="Control"&&(C=!0,t.domElement.getRootNode().addEventListener("keyup",We,{passive:!0,capture:!0}))}function We(i){i.key==="Control"&&(C=!1,t.domElement.getRootNode().removeEventListener("keyup",We,{passive:!0,capture:!0}))}function pe(i){t.enabled===!1||t.enablePan===!1||to(i)}function Xe(i){switch(Ke(i),y.length){case 1:switch(t.touches.ONE){case a.TOUCH.ROTATE:if(t.enableRotate===!1)return;Ve(i),r=s.TOUCH_ROTATE;break;case a.TOUCH.PAN:if(t.enablePan===!1)return;Be(i),r=s.TOUCH_PAN;break;default:r=s.NONE}break;case 2:switch(t.touches.TWO){case a.TOUCH.DOLLY_PAN:if(t.enableZoom===!1&&t.enablePan===!1)return;oo(i),r=s.TOUCH_DOLLY_PAN;break;case a.TOUCH.DOLLY_ROTATE:if(t.enableZoom===!1&&t.enableRotate===!1)return;io(i),r=s.TOUCH_DOLLY_ROTATE;break;default:r=s.NONE}break;default:r=s.NONE}r!==s.NONE&&t.dispatchEvent(le)}function lo(i){switch(Ke(i),r){case s.TOUCH_ROTATE:if(t.enableRotate===!1)return;Ue(i),t.update();break;case s.TOUCH_PAN:if(t.enablePan===!1)return;Ne(i),t.update();break;case s.TOUCH_DOLLY_PAN:if(t.enableZoom===!1&&t.enablePan===!1)return;so(i),t.update();break;case s.TOUCH_DOLLY_ROTATE:if(t.enableZoom===!1&&t.enableRotate===!1)return;no(i),t.update();break;default:r=s.NONE}}function $e(i){t.enabled!==!1&&i.preventDefault()}function uo(i){y.push(i.pointerId)}function ho(i){delete j[i.pointerId];for(let d=0;d<y.length;d++)if(y[d]==i.pointerId){y.splice(d,1);return}}function mo(i){for(let d=0;d<y.length;d++)if(y[d]==i.pointerId)return!0;return!1}function Ke(i){let d=j[i.pointerId];d===void 0&&(d=new a.Vector2,j[i.pointerId]=d),d.set(i.pageX,i.pageY)}function N(i){const d=i.pointerId===y[0]?y[1]:y[0];return j[d]}t.domElement.addEventListener("contextmenu",$e),t.domElement.addEventListener("pointerdown",Ye),t.domElement.addEventListener("pointercancel",W),t.domElement.addEventListener("wheel",Ze,{passive:!1}),t.domElement.getRootNode().addEventListener("keydown",He,{passive:!0,capture:!0}),this.update()}}class jt extends Pt{constructor(e,o){super(e,o),this.screenSpacePanning=!1,this.mouseButtons={LEFT:a.MOUSE.PAN,MIDDLE:a.MOUSE.DOLLY,RIGHT:a.MOUSE.ROTATE},this.touches={ONE:a.TOUCH.PAN,TWO:a.TOUCH.DOLLY_ROTATE}}}class At extends a.EventDispatcher{scene;renderer;camera;controls;ambLight;dirLight;container;_clock=new a.Clock;_fogFactor=1;get fogFactor(){return this._fogFactor}set fogFactor(e){this._fogFactor=e,this.controls.dispatchEvent({type:"change",target:this.controls})}get width(){return this.container.clientWidth}get height(){return this.container.clientHeight}constructor(e,o={centerPostion:new a.Vector3(0,0,-3e3),cameraPosition:new a.Vector3(0,3e4,0)}){super();const t=typeof e=="string"?document.querySelector(e):e;if(t instanceof HTMLElement)this.container=t,this.renderer=this._createRenderer(),this.scene=this._createScene(),this.camera=this._createCamera(o.cameraPosition),this.controls=this._createControls(o.centerPostion),this.ambLight=this._createAmbLight(),this.scene.add(this.ambLight),this.dirLight=this._createDirLight(o.centerPostion),this.scene.add(this.dirLight),this.container.appendChild(this.renderer.domElement),window.addEventListener("resize",this.resize.bind(this)),this.resize(),this.renderer.setAnimationLoop(this.animate.bind(this));else throw`${e} not found!}`}_createScene(){const e=new a.Scene,o=14414079;return e.background=new a.Color(o),e.fog=new a.FogExp2(o,0),e}_createRenderer(){const e=new a.WebGLRenderer({antialias:!1,alpha:!0,logarithmicDepthBuffer:!0,precision:"highp"});return e.debug.checkShaderErrors=!0,e.sortObjects=!0,e.setPixelRatio(window.devicePixelRatio),e}_createCamera(e){const o=new a.PerspectiveCamera(70,1,.1,5e4);return o.position.copy(e),o}_createControls(e){const o=new jt(this.camera,this.container);return o.target.copy(e),o.screenSpacePanning=!1,o.minDistance=.1,o.maxDistance=3e4,o.enableDamping=!0,o.keyPanSpeed=5,o.listenToKeyEvents(window),o.addEventListener("change",()=>{const t=Math.max(this.controls.getPolarAngle(),.1),s=Math.max(this.controls.getDistance(),.1);o.zoomSpeed=Math.max(Math.log(s),1.8),this.camera.far=a.MathUtils.clamp(s/t*8,100,5e4),this.camera.near=this.camera.far/1e3,this.camera.updateProjectionMatrix(),this.scene.fog instanceof a.FogExp2&&(this.scene.fog.density=t/(s+5)*this.fogFactor*.25),s>8e3?(o.minAzimuthAngle=0,o.maxAzimuthAngle=0):(o.minAzimuthAngle=-1/0,o.maxAzimuthAngle=1/0),o.maxPolarAngle=Math.min(Math.pow(1e4,4)/Math.pow(s,4),1.3)}),o}_createAmbLight(){return new a.AmbientLight(16777215,1)}_createDirLight(e){const o=new a.DirectionalLight(16777215,1);return o.position.set(0,2e3,1e3),o.target.position.copy(e),o}resize(){const e=this.width,o=this.height;return this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(e,o),this.camera.aspect=e/o,this.camera.updateProjectionMatrix(),this}animate(){this.controls.update(),this.renderer.render(this.scene,this.camera),this.dispatchEvent({type:"update",delta:this._clock.getDelta()})}}class Ot extends L{token="";format="webp";style="mapbox.satellite";attribution="MapBox";maxLevel=19;url="https://api.mapbox.com/v4/{style}/{z}/{x}/{y}.{format}?access_token={token}";constructor(e){super(e),Object.assign(this,e)}}class Ct extends L{dataType="image";attribution="ArcGIS";style="World_Imagery";url="https://services.arcgisonline.com/arcgis/rest/services/{style}/MapServer/tile/{z}/{y}/{x}";constructor(e){super(e),Object.assign(this,e)}}class Dt extends L{dataType="lerc";attribution="ArcGIS";maxLevel=13;url="https://elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer/tile/{z}/{y}/{x}";constructor(e){super(e),Object.assign(this,e)}}class It extends L{dataType="image";attribution="Bing[GS(2021)1731号]";style="A";mkt="zh-CN";subdomains="123";constructor(e){super(e),Object.assign(this,e)}getUrl(e,o,t){const s=zt(t,e,o);return`https://t${this.s}.dynamic.tiles.ditu.live.com/comp/ch/${s}?mkt=${this.mkt}&ur=CN&it=${this.style}&n=z&og=804&cstl=vb`}}function zt(n,e,o){let t="";for(let s=n;s>0;s--){const r=1<<s-1;let c=0;e&r&&c++,o&r&&(c+=2),t+=c}return t}class kt extends L{dataType="image";attribution="高德[GS(2021)6375号]";style="8";subdomains="1234";maxLevel=18;url="https://webst0{s}.is.autonavi.com/appmaptile?style={style}&x={x}&y={y}&z={z}";constructor(e){super(e),Object.assign(this,e)}}class Rt extends L{dataType="image";maxLevel=16;attribution="GeoQ[GS(2019)758号]";style="ChinaOnlineStreetPurplishBlue";url="https://map.geoq.cn/ArcGIS/rest/services/{style}/MapServer/tile/{z}/{y}/{x}";constructor(e){super(e),Object.assign(this,e)}}class Vt extends L{dataType="image";attribution="Google";maxLevel=20;style="y";subdomains="0123";url="https://gac-geo.googlecnapps.club/maps/vt?lyrs={style}&x={x}&y={y}&z={z}";constructor(e){super(e),Object.assign(this,e)}}class Bt extends L{attribution="MapTiler";token="get_your_own_key_QmavnBrQwNGsQ8YvPzZg";format="jpg";style="satellite-v2";url="https://api.maptiler.com/tiles/{style}/{z}/{x}/{y}.{format}?key={token}";constructor(e){super(e),Object.assign(this,e)}}class Ft extends L{dataType="image";attribution="Stadia";url="https://tiles.stadiamaps.com/tiles/alidade_satellite/{z}/{x}/{y}.jpg";constructor(e){super(e),Object.assign(this,e)}}class Ut extends L{dataType="image";attribution="天地图[GS(2023)336号]";token="";style="img_w";subdomains="01234";url="https://t{s}.tianditu.gov.cn/DataServer?T={style}&x={x}&y={y}&l={z}&tk={token}";constructor(e){super(e),Object.assign(this,e)}}class Nt extends L{dataType="image";style="sateTiles";attribution="腾讯[GS(2023)1号]";subdomains="0123";maxLevel=18;constructor(e){super(e),Object.assign(this,e)}getUrl(e,o,t){const s=e>>4,r=(1<<t)-o>>4,c=Math.pow(2,t)-1-o;return`https://p${this.s}.map.gtimg.com/${this.style}/${t}/${s}/${r}/${e}_${c}.jpg`}}class Gt extends L{attribution="中科星图[GS(2022)3995号]";token="";style="img";format="webp";subdomains="12";url="https://tiles{s}.geovisearth.com/base/v1/{style}/{z}/{x}/{y}?format={format}&tmsIds=w&token={token}";constructor(e){super(e),Object.assign(this,e)}}const Yt=`
varying vec2 vUv;
uniform vec3 bkColor;
uniform vec3 airColor;

void main() {  
    vUv = uv;
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);  
}  
`,Zt=`



varying vec2 vUv;
uniform vec3 bkColor;
uniform vec3 airColor;

void main() {   

    // 当前点距中点的距离
    float d = distance(vUv, vec2(0.5f))*5.0f;
    
    if(d<0.49f){
        // 球体颜色
        float a = smoothstep(0.0f,0.4f,d-0.12f);     
        gl_FragColor = vec4(vec3(0.0f), a);               
    } else if(d<0.5){
        float c = (d-0.48f)/0.02f;
        gl_FragColor =vec4(mix(vec3(0.0f),airColor,c*c),1.5f-d);
    } else if(d<0.53f){
        // 光晕(0.48-0.52)
        float c = (d-0.49f)/0.04f;
        gl_FragColor = vec4(mix(airColor,bkColor,sqrt(c)),1.0);
    } else{
        // 球体外颜色
        gl_FragColor = vec4(bkColor,1.0f);
    }
    
    // #include <tonemapping_fragment>
    // #include <encodings_fragment>    
    // #include <colorspace_fragment>
    
}  
`;class Ce extends a.ShaderMaterial{constructor(e){super({uniforms:a.UniformsUtils.merge([a.UniformsLib.fog,{bkColor:{value:e.bkColor},airColor:{value:e.airColor}}]),transparent:!0,depthTest:!1,vertexShader:Yt,fragmentShader:Zt,lights:!1})}}class Ht extends a.Mesh{get bkColor(){return this.material.uniforms.bkColor.value}set bkColor(e){this.material.uniforms.bkColor.value.set(e)}constructor(e,o=new a.Color(6724044)){super(new a.PlaneGeometry(5,5),new Ce({bkColor:e,airColor:o})),this.renderOrder=999}}const Wt=Object.freeze(Object.defineProperty({__proto__:null,ArcGisDemSource:Dt,ArcGisSource:Ct,BingSource:It,EarthMaskMaterial:Ce,FakeEarth:Ht,GDSource:kt,GLViewer:At,GeoqSource:Rt,GoogleSource:Vt,MapBoxSource:Ot,MapTilerSource:Bt,StadiaSource:Ft,TDTSource:Ut,TXSource:Nt,ZKXTSource:Gt},Symbol.toStringTag,{value:"Module"})),Xt=fe.version,$t=fe.author;g.FileLoaderEx=xe,g.ImageLoaderEx=se,g.LoaderFactory=T,g.RootTile=be,g.Tile=G,g.TileGridGeometry=Te,g.TileLoader=Le,g.TileMap=ce,g.TileMaterial=we,g.TileSimpleGeometry=nt,g.TileSource=L,g.TileTextureLoader=ve,g.author=$t,g.getSafeTileUrlAndRect=re,g.plugin=Wt,g.rect2ImageBounds=ne,g.resizeImage=ct,g.version=Xt,Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});
